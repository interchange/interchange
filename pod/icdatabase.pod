=head1 NAME

Interchange Databases

=head1 AKOPIA INTERCHANGE(TM) DATABASES

Akopia Interchange is the industry's most widely distributed and
implemented open source e-commerce platform. This document discusses
databases, SQL support, the Interchange search engine, frequently
asked questions, and usertags.

=head2 A Typical User Session

The customer discovers a merchant site using the Interchange catalog
with a search engine, a link from another page, or a click-through
from a banner ad. He or she clicks the link, which is a URL pointing
to the Interchange CGI link program (generically called VLINK or
TLINK). The link calls the Interchange server through a socket. The
Interchange server detects the path information from the link, and
loads the corresponding page.

The displayed page contains links to either locate or order items from
the merchant's catalog. When the customer clicks a link to purchase an
item, Interchange searches the product database, finds the item, and
places it in the customer's shopping cart. (Each user has a separate
shopping cart, which is attached to their session.)

Once the customer decides to purchase the items in their shopping
cart, he or she checks out by completing a form with their name,
address, payment information, shipping information, and any other
information that may be required. Interchange has the capacity to
compute sales taxes and shipping cost. The order is then submitted.
The customer's payment can be taken online by real-time electronic
payment, or their order information may be transmitted using encrypted
email or FAX to a processing center.

The customer's order is saved to a file or to a database table as
backup. In the case of fully automated systems, it can be sent
directly to an order entry program or database link.

All of these operations are fully configurable. The Interchange demo
program includes a sample store called Construct Something. Some users
have actually customized the text and images inside Construct
Something's sample catalogs, changed the database entries, and opened
their store. Most users, however, have built their catalogs using
their own distinctive look and feel.

=head1 DATABASES

As with most powerful shopping cart programs, Interchange is all about
databases. Interchange can use GDBM, DB_File, SQL, LDAP, or in-memory
database formats. In most cases, these different database formats
should operate the same when called by Interchange's access methods.

B<Note: >No other database besides Interchange's internal one is
required.

Keeping a database in an SQL manager makes it easier to integrate
Interchange with other tools. Interchange can be used to maintain a
spreadsheet containing product information by only modifying the file
C<products.txt> as needed. References to SQL, DBI, and DBD can be
ignored.

=head2 Text Source Files

Interchange reads delimited text files to obtain data. However, the
text files are not the database. They are the source information for
the database tables.

Note the following configuration directive:

   Database  products  products.txt   TAB

This says that the C<products> table will obtain its source
information from the file C<products.txt>. What is done with it
depends on the type of underlying database being used. The different
types:

=over 4

=item GDBM

The database source file is checked to see if it is newer than the
actual database file, which would be C<products.gdbm>. If it is, then
the database table is re-imported from the file.

This behavior can be changed in a couple of ways. If files are never
to be imported unless the C<.gdbm> file disappears, set the
C<NoImport> directive:

    NoImport  products

If the database source file is only imported at catalog start-up time,
use the IMPORT_ONCE modifier:

    Database products IMPORT_ONCE 1

GDBM is the default type if the GDBM_File Perl module is installed (as
it will be on LINUX).

=item DB_File

The database source file is checked to see if it is newer than the
actual database file, which would be C<products.db>. If it is, then
the database table is re-imported from the file. You can change this
behavior in the same way as with GDBM_File (above).

DB_File is the default type if the GDBM_File Perl module is not
installed. This is typical on FreeBSD. To explicitly specify DB_File
as the type, specify it with a Database directive in C<catalog.cfg>:

   Database  products  DB_FILE   1

=item DBI/SQL

If a file named C<products.sql> is present in the same directory as
C<products.txt>, the database table will not be imported from ASCII
source. If there is no C<products.sql>, the following will occur:

DBI/SQL imports only happen at catalog configuration time.

=over 8

=item

Interchange will connect to the SQL database using the specified DSN.
(DBI parameter meaning "Database Source Name".)

The table will be dropped with "DROP TABLE products;". This will occur
without warning! NOTE: This can be prevented in several ways. See
C<NoImport External> or the SQL documentation.

The table will be created. If there are COLUMN_DEF specifications in
C<catalog.cfg>, they will be used. Otherwise, the key (first field in
the text file by default) will be created with a C<char(16)> type and
all other fields will be created as C<char(128)>. The table creation
statement will be written to the C<error.log> file.

The text source file will be imported into the SQL database.
Interchange will place the data in the columns. Data typing must be
user-configured. This means that if "none" is placed in a field, and
it is defined as a numeric type, the database import will not succeed.
If it does not, the catalog will not become active.

=back

=item In-Memory

Every time the catalog is configured, the C<products.txt> file is
imported into memory and forms the database. The database is not
changed otherwise. In-memory is the default type if there is no
GDBM_File or DB_File Perl module installed; specify it with:

   Database   products   MEMORY   1

=back

=head2 Interchange Database Operation

B<Note: >In the following descriptions, the following terms are used
somewhat interchangeably:

=over 4

=item key, code

Either one is a reference to the key for the database. In Interchange,
this is often the product code or SKU, which is the part number for
the product. Other key values may be used to generate relationships to
other database tables.

It is suggested that the key be the first column of the ASCII source
file, since Interchange's import, export, and search facilities will
work much better with that practice.

=item field, column

This is a column of the database. One of the columns is always the
key; Interchange prefers that the key be the first column.

=item table, database

A table in the database. Because of the evolution of Interchange from
a single-table database to an access method for an unlimited number of
tables (and databases, for that matter), a table will sometimes be
referred to as a database. The only time database refers to something
different is when describing that concept as it relates to SQL, where
a database contains a series of tables. Interchange cannot create SQL
databases, but given the proper permissions it may drop and create
tables within that database.

=back

If necessary, Interchange reads the data to place in tables from
standard ASCII-delimited files. All of these ASCII source files are
kept in the products directory, normally products in the catalog
directory (where catalog.cfg is located). The ASCII files can have ^M
(carriage return) characters if desired, but must have a new line
character at the end of the line to work. NOTE: Mac users uploading
files must use ASCII mode, not binary mode.

Interchange's default ASCII delimiter is TAB.

IMPORTANT NOTE: The items must be separated by a single delimiter. The
items are lined up for reading convenience.

=over 4

=item TAB

Fields separated by C<^I> characters. No whitespace should be at the
beginning of the line.

    code    description             price      SH543   Men's fine cotton shirt 14.95   shirts.jpg

image

=item PIPE

Fields separated by C<|> characters. No whitespace should be at the
beginning of the line.

    code|description|price    SH543|Men's fine cotton shirt|14.95|shirts.jpg

image

=item CSV

Fields enclosed in quotes, separated by commas. No whitespace should
be at the beginning of the line.

    "code","description","price","    "SH543","Men's fine cotton shirt","14.95","shirts.jpg"

mage"

=back

B<Note: >Using the default TAB delimiter is highly recommended, if
searching the ASCII source file of the database is planned. PIPE works
fairly well, but CSV delimiter schemes cause problems with searching.

B<IMPORTANT NOTE: >Field names are usually case-sensitive. Unless
there is consistency in the names, there will be problems. All lower
or all upper case names are recommended.

=over 4

=item

Interchange uses one mandatory database, which is referred to as the
products database. In the supplied demo catalogs, it is called
products and the ASCII source is kept in the file C<products.txt> in
the products directory. This file is also the default file for
searching with the THE SEARCH ENGINE.

Interchange also has a two of standard, but optional, databases, which
are in fixed special formats:

=over 8

=item shipping.asc

The database of shipping options if the C<CustomShipping> directive is
in use.  This is a fixed-format database, and must be created as
specified. See C<SHIPPING>.

=item salestax.asc

The database of sales tax information if the C<[salestax]> tag is to
be used. A default is supplied. NOTE: Caution, these things change!
This is a fixed-format database, and must be created as specified. See
Sales Tax.

=back

These are never stored in SQL or DBM.

=back

=head2 The Product Database

Each product being sold should be given a product code, usually
referred to as SKU, a short code that identifies the product on the
ordering page and in the catalog. The products.txt file is a
ASCII-delimited list of all the product codes, along with an arbitrary
number of fields which must contain at least the fields C<description>
and C<price> (or however the C<PriceField> and C<DescriptionField>
directives have been set). Any additional information needed in the
catalog can be placed in any arbitrary field. See Interchange Database
Capability for details on the format.

Field names can be case-sensitive depending on the underlying database
type. Unless there are fields with the names "description" and "price"
field, set the C<PriceField> and C<DescriptionField> directives to use
the C<[item-price]> and C<[item-description]> tags.

The product code, or SKU, must be the first field in the line, and
must be unique. Product codes can contain the characters B<A-Za-z0-9>,
along with hyphen (C<->), underscore (C<_>), pound sign/hash mark
(C<#>), slash (C</>), and period (C<.>). Note that slash (/) will
interfere with on-the-fly page references. Avoid if at all possible.

The words should be separated by one of the approved delimiting
schemes (TAB, PIPE, or CSV), and are case-sensitive in some cases. If
the case of the "description" or "price" fields have been modified,
the C<PriceField> and C<DescriptionField> directives must be
appropriately set.

B<Note: >CSV is not recommended as the scheme for the products
database. It is much slower than TAB- or PIPE-delimited, and
dramatically reduces search engine functionality. No field-specific
searches are possible. Using CSV for any small database that will not
be searched is fine.

B<IMPORTANT NOTE: >The field names must be on the first line of the
C<products.txt> file. These field names must match exactly the field
names of the C<[item-field]> tags in the catalog pages, or the
Interchange server will not access them properly. Field names can
contain the characters A-Za-z0-9 and underscore (C<_>).

More than one database may be used as a products database. If the
catalog directive, ProductFiles, is set to a space-separated list of
valid Interchange database identifiers, those databases will be
searched (in the order specified) for any items that are ordered, or
for product information (as in the C<[price code]> and C<[field code]>
tags).

When the database table source file (i.e., products.txt) changes after
import or edit, a DBM database is re-built upon the next user access.
No restart of the server is necessary.

If changing the database on-the-fly, it is recommended that the file
be locked while it is being modified. Interchange's supplied import
routines do this.

=head2 Multiple Database Tables

Interchange can manage an unlimited number of arbitrary database
tables. They use the TAB delimiter by default, but several flexible
delimiter schemes are available. These are defined by default:

   Type 1      DEFAULT - uses default TAB delimiter
   Type 2      LINE
               Each field on its own line, a blank line
               separates the record. Watch those carriage
               returns! Also has a special format when CONTINUE
               is set to be NOTES.
   Type 3      %%
               Fields separated by a \n%%\n combination, records by
               \n%%%\n (where \n is a newline). Watch those carriage
               returns!
   Type 4      CSV
   Type 5      PIPE
   Type 6      TAB
   Type 7      reserved
   Type 8      SQL

The databases are specified in C<Database> directives, as:

   Database    arbitrary arbitrary.csv CSV

This specifies a Type 4 database, the ASCII version of which is
located in the file C<arbitrary.csv>, and the identifier it will be
accessed under in Interchange is "arbitrary." The DBM file, if any,
will be created in the same directory if the ASCII file is newer, or
if the DBM file does not exist. The files will be created as
C<arbitrary.db> or C<arbitrary.gdbm>, depending on DBM type.

The C<identifier> is case sensitive, and can only contain characters
in the class [A-Za-z0-9_]. Fields are accessed with the [item_data
C<identifier> field] or [data C<identifier> field key] elements. NOTE:
Use of lower-case letters is strongly recommended.

If one of the first six types is specified, the database will
automatically be built in the default Interchange DB style. The type
can be specified with DB_FILE, GDBM, or MEMORY, if the type varies
from that default. They will coexist with an unlimited number of DBI
databases of different types.

In addition to the database, the session files will be kept in the
default format, and are affected by the following actions.

The order of preference is:

=over 4

=item GDBM

This uses the Perl C<GDBM_File> module to build a GDBM database. The
following command will indicate if GDBM is in Perl:

    perl -e 'require GDBM_File and print "I have GDBM.\n"'

Installing GDBM_File requires rebuilding Perl after obtaining the GNU
GDBM package, and is beyond the scope of this document. LINUX will
typically have this by default; most other operating systems will need
to specifically build in this capability.

=item DB_File (Berkeley DB)

This uses the C<DB_File> module to build a Berkeley DB (hash)
database. The following command will indicate if DB_File is in Perl:

    perl -e 'require DB_File and print "I have Berkeley DB.\n"'

Installing C<DB_File> requires rebuilding Perl after obtaining the
Berkeley DB package, and is beyond the scope of this document. BSDI,
FreeBSD, and LINUX will typically have it by default; most other
operating systems will need to specifically build this in.

If using C<DB_File>, even though C<GDBM_File> is in Perl, set the
environment variable MINIVEND_DBFILE to a true (non-zero, non-blank)
value:

    # csh o    setenv MINIVEND_DBFILE 1

    # sh, bash, or ksh
    MINIVEND_DBFILE=1 ; export MINIVEND_DBFILE

 tcsh

Then, re-start the server.

Or, to set a particular table to use Berkeley DB, the DB_FILE class in
C<catalog.cfg> can be specified:

    Database arbitrary  DB_FILE  1

=item In-memory

This uses Perl hashes to store the data directly in memory. Every time
the Interchange server is restarted, it will re-import all in-memory
databases for every catalog.

If this is used, despite the presence of C<GDBM_File> or C<DB_File>,
set the environment variable MINIVEND_NODBM as above or specify the
memory type in the Database directive:

    Database arbitrary  MEMORY  1

=back

B<Note: >The use of memory databases is not recommendeded.

=head2 Character Usage Restrictions

To review, database identifiers, field names, and product codes
(database keys) are restricted in the characters they may use. The
following table shows the restrictions:

                                      Legal characters
                                      ---------------------
   Database identifiers               A-Z a-z 0-9 _
   Field names                        A-Z a-z 0-9 _
   Database keys (product code/SKU)   A-Z a-z 0-9 _ # - . /
   Database values                    Any (subject to field/record delimiter)

Some SQL databases have reserved words which cannot be used as field
names; Interchange databases do not have this restriction.

For easy HTML compatibility, it is not recommended that a / be used in
a part number if using the flypage capability. It can still be called
[page href=flypage arg="S/KU"].

=head2 Database Attributes

Especially in SQL databases, there are certain functions that can be
set with additional database attributes. For text import, the CONTINUE
extended database import attribute allows additional control over the
format of imported text.

B<Note: >CONTINUE applies to all types except CSV. (Do not use NOTES
unless using type LINE.)

=over 4

=item CONTINUE

One of UNIX, DITTO, LINE, NONE, or NOTES. The default, NONE, is to
simply split the line/record according to the delimiter, with no
possible spanning of records. Setting CONTINUE to UNIX appends the
next line to the current when it encounters a backslash (C<\>) at the
end of a record, just like many UNIX commands and shells.

DITTO is invoked when the key field is blank. It adds the contents of
following fields to the one above, separated by a new line character.
This allows additional text to be added to a field beyond the 255
characters available with most spreadsheets and flat-file databases.

Example in catalog.cfg:

  Database products products.tx  Database products CONTINUE      DITTO

  TAB

Products.asc file:

  code     price     descr  00-0011  500000    The Mona Lisa, one of the worlds great masterpieces.
                     Now at a reduced price!

ption

The description for product 00-0011 will contain the contents of the
C<description> field on both lines, separated by a new line.

=back

B<Note: >Fields are separated by tabs, formatted for reading
convenience.

=over 4

=item

This will work for multiple fields in the same record. If the field
contains any non-empty value, it will be appended.

LINE is a special setting so a multi-line field can be used. Normally,
when using the LINE type, there is only data on one line separated by
one blank line. When using CONTINUE LINE, there may be some number of
fields which are each on a line, while the last one spans multiple
lines up until the first blank line.

Example in catalog.cfg:

  Database products products.txt  Database products CONTINUE      LINE

 LINE

Products.asc file:

      price
    description

    00-0011
    500000
    The Mona Lisa, one of the worlds great masterpieces.
    Now at a reduced price!

    00-0011a
    1000
    A special frame for the Mona Lisa.

 code

NOTES reads a Lotus Notes "structured text" file. The format is any
number of fields, all except one of which must have a field name
followed by a colon and then the data. There is optional whitespace
after the colon.

Records are separated by a settable delimiting character which goes on
a line by itself, much like a "here document." By default, it is a
form feed (^L) character. The final field begins at the first blank
line and continues to the end of the record. This final field is named
C<notes_field>, unless set as mentioned below.

Interchange reads the field names from the first paragraph of the
file. The key field should be first, followed by other fields in any
order. If one (and only one) field name has whitespace, then its name
is used for the C<notes_field>. Any characters after a space or TAB
are used as the record delimiter.

If there are none, then the delimiter returns to the default form feed
(^L) and the field name reverts to C<notes_field>. The field in
question will be discarded, but a second field with whitespace will
cause an import error. Following records are then read by name, and
only fields with data in them need be set. Only the C<notes_field> may
contain a new line. It is always the last field in the record, and
begins at the B<first> blank line.

The following example sets the delimiter to a tilde C<(~)> and renames
the C<notes_field> to C<description>.

Example in catalog.cfg:

  Database products products.txt  Database products CONTINUE      NOTES

 LINE

Products.asc file:

      title
    price
    image
    description ~
    size
    color

    title: Mona Lisa
    price: 500000
    code: 00-0011
    image: 00-0011.jpg

    The Mona Lisa, one of the worlds great masterpieces.
    Now at a reduced price!
    ~
    title: The Art Store T-Shirt
    code: 99-102
    size: Medium, Large*, XL=Extra Large
    color: Green, Blue, Red, White*, Black
    price: 2000

    Extra large 1.00 extra.
    ~

 code

=back

=over 4

=item EXCEL

Microsoft Excel is a widely-used tool to maintain Interchange
databases, but has several problems with its standard TAB-delimited
export, like encasing fields containing commas in quotes, generating
extra carriage returns embedded in records, and not including trailing
blank fields. To avoid problems, use a text-qualifier of none.

Set the EXCEL attribute to 1 to fix these problems on import:

    Database products EXCEL 1

This is normally used only with TAB-delimited files.

=back

=head2 Dictionary Indexing With INDEX

Interchange will automatically build index files for a fast binary
search of an individual field. This type of search is useful for
looking up the author of a book based on the beginning of their last
name, a book title based on its beginning, or other similar
situations.

Such a search requires a dictionary ordered index with the field to be
searched contained in the first field and the database key (product
code) in the second field. If the C<INDEX field> modifier is
specified, Interchange will build the index upon database import:

  Database  products  products.txt   TAB
  Database  products  INDEX          title

If the C<title> field is the fourth column in the C<products> database
table, a file C<products.txt.4> will be built, containing two
tab-separated fields something like:

   American Gothic   19-202
   Mona Lisa         00-0011
   Sunflowers        00-342
   The Starry Night  00-343

Options can be appended to the field name after a colon (:). The most
useful will be C<f>, which does a case-insensitive sort. The
C<mv_dict_fold> option must be added to the search in this case.

Another option is C<c>, which stands for "comma index." To index on
comma-separated sub-fields within a field, use the :c option:

  Database  products  products.txt   TAB
  Database  products  INDEX          category:c

This can get slow for larger databases and fields. Interchange will
split the field on a comma (stripping surrounding whitespace) and make
index entries for each one. This allows multiple categories in one
field while retaining the fast category search mechanism. It might
also be useful for a C<keywords> field.

The fast binary search is described in greater detail in THE SEARCH
ENGINE below.

=head2 MEMORY for Memory-Only Databases

Interchange's memory-based databases are the fastest possible way to
organize and store frequently used data. To force a database to be
built in memory instead of DBM, use the MEMORY modifier:

  Database  country  country.asc   TAB
  Database  country  MEMORY        1

Obviously, large tables will use a great deal of memory, and the data
will need to be re-imported from the ASCII source file at every
catalog reconfiguration or Interchange restart. The big advantage of
using MEMORY is that the database remains open at all times and does
not need to be reinitialized at every connect. Use it for smaller
tables that will be frequently accessed.

The MEMORY modifier forces IMPORT_ONCE.

=head2 IMPORT_ONCE

The IMPORT_ONCE modifier tells Interchange not to re-import the
database from the ASCII file every time it changes. Normally,
Interchange does a comparison of the database file modification time
with the ASCII source every time it is accessed, and if the ASCII
source is newer it will re-import the file.

IMPORT_ONCE tells it only to import on a server restart or catalog
reconfiguration:

  Database  products  products.txt   TAB
  Database  products  IMPORT_ONCE    1

SQL databases don't normally need this. They will only be imported
once in normal operation. Also see C<NoImport> for a way to guarantee
that the table will never be imported.

IMPORT_ONCE is always in effect for MEMORY databases. A catalog
reconfiguration is required to force a change.

=head2 Importing in a Page

To add a data record to a database as a result of an order or other
operation, use Interchange's C<[import ...]> tag.

=over 4

=item [import table type*] RECORD [/import]

Named parameters:

 [import table=tabl         file=filename*
         type=(TAB|PIPE|CSV|%%|LINE)*
         continue=(NOTES|UNIX|DITTO)*
         separator=c*]

_name

=back

Import one or more records into a database. The C<type> is any of the
valid Interchange delimiter types, with the default being TAB. The
table must already be a defined Interchange database table. It cannot
be created on-the-fly. If on-the-fly functionality is need, it is time
to use SQL.

The import type selected need not match the type the database was
specified. Different delimiters may be used.

The C<type> of C<LINE> and C<continue> setting of C<NOTES> is
particularly useful, for it allows fields to be named and not have to
be in any particular order of appearance in the database. The
following two imports are identical in effect:

   [import table=orders]
            code: [value mv_order_number]
   shipping_mode: [shipping-description]
          status: pending
   [/import]

   [import table=orders]
   shipping_mode: [shipping-description]
   status:        pending
   code:          [value mv_order_number]
   [/import]

The C<code> or key must always be present, and is always named
C<code>. If C<NOTES> mode is not used, the fields must be imported in
the same order as they appear in the ASCII source file.

The C<file> option overrides the container text and imports directly
from a named file based in the catalog directory. To import from
C<products.txt>, specify C<file="products/products.txt">. If the
NoAbsolute directive is set to C<Yes> in minivend.cfg, only relative
path names will be allowed.

The C<[import ....] TEXT [/import]> region may contain multiple
records. If using C<NOTES> mode, a separator must be used, which, by
default, is a form-feed character (^L). See Import Attributes for more
information.

=head2 Exporting from a Database

To export an existing database to a file suitable for searching by
Interchange, create an AdminPage (or any page, for that matter) that
contains a C<[tag export ...][/tag]> element. Perhaps a better method
is to define the same sort of tags in an OrderProfile, and use forms
and buttons to access the profile.

=head2 Write Control

Interchange databases can be written in the normal course of events,
either using the C<[import ...]> tag or with a tag like C<[data
table=table column=field key=code value=new-value]>. To control
writing of a global database, or to a certain catalog within a series
of subcatalogs, or make one read only, see the following:

To enable write control:

   Database   products  WRITE_CONTROL  1

Once this is done, to make a database read only, which won't allow
writing even if C<[tag flag write]products[/tag]> is specified:

   Database   products  READ_ONLY  1

To have control with C<[tag flag write]products[/tag]>:

   Database   products  WRITE_TAGGED  1

To limit write to certain catalogs, set:

   Database   products  WRITE_CATALOG  simple=0, sample=1

The "simple" catalog will not be able to write, while "sample" will if
C<[tag flag write]products[/tag]> is enabled. If a database is to
always be writable, without having to specify C<[tag flag write] ...
[/tag]>, then define:

   Database   products  WRITE_ALWAYS  1

The default behavior of SQL datbases is equivalent to WRITE_ALWAYS,
while the default for GDBM_File, DB_File, and Memory databases is
equivalent to:

   Database   products  WRITE_CONTROL 1
   Database   products  WRITE_TAGGED  1

=head2 Global Databases

If a database is to be available to all catalogs on the Interchange
server, it may be defined in C<minivend.cfg>. Any catalog running
under that server will be able to use it. NOTE: It is writable by any
catalog unless WRITE_CONTROL is used.

=head1 SQL SUPPORT

Interchange can use any of a number of SQL databases through the
powerful Perl DBI/DBD access methods. This allows transparent access
to any database engine that is supported by a DBD module. The current
list includes mSQL, mySQL, Solid, Postgres, Oracle, Sybase, Informix,
Ingres, Dbase, DB2, Fulcrum, and others. Any ODBC (with appropriate
driver) should also be supported.

No SQL database is included with Interchange, but there are a number
widely available on the Internet. Many are free for non-commercial
use, such as mSQL, mySQL, Sybase, and Qbase. It is beyond the scope of
this document to describe SQL or DBI/DBD. Sufficient familiarity is
assumed.

In most cases, Interchange cannot perform administrative functions,
like creating a database or setting access permissions. This must be
done with the tools provided with a SQL distribution. But, if given a
blank database and the permission to read and write it, Interchange
can import ASCII files and bootstrap from there.

=head2 SQL Support via DBI

The configuration of the DBI database is accomplished by setting
attributes in additional Database directives after the initial
defining line as described above. For example, the following defines
the database B<arbitrary> as a DBI database, sets the data source
(DSN) to an appropriate value for an mSQL database named C<minivend>
on port 1114 of the local machine:

   Database arbitrary arbitrary.asc SQL
   Database arbitrary DSN           dbi:mSQL:minivend:localhost:1114

As a shorthand method, include the DSN as the type:

   Database arbitrary arbitrary.asc dbi:mSQL:minivend:localhost:1114

Supported configuration attributes include (but are not limited to):

=over 4

=item DSN

A specification of the DBI driver and its data source. To use the
DBD::mSQL driver for DBI, use:

    dbi:mSQL:minivend:othermachine.my.com:1112

where mSQL selects the driver (case IS important), C<minivend> selects
the database, C<othermachine.my.com> selects the host, and 1112 is the
port. On many systems, C<dbi:mSQL:minivend> will work fine. Of course,
the C<minivend> database must already exist.

This is the same as the DBI_DSN environment variable, if the DSN
parameter is not set. Then, the value of DBI_DSN will be used to try
and find the proper database to connect to.

=item USER

The user name used to log into the database. It is the same as the
environment variable B<DBI_USER>. If a user name is not needed, just
don't set the USER directive.

=item PASS

The password used to log into the database. It is the same as the
environment variable B<DBI_PASS>. If a password is not needed, just
don't set the PASS directive.

=item COLUMN_DEF

A comma-separated set of lines in the form NAME=TYPE(N), where NAME is
the name of the field/column, TYPE is the SQL data type reference, and
N is the length (if needed). Most Interchange fields should be the
fixed-length character type, something like char(128). In fact, this
is the default if a type is not chosen for a column. There can be as
many lines as needed. This is not a DBI parameter, it is specific to
Interchange.

=item NAME

A space-separated field of column names for a table. Normally not
used. Interchange should resolve the column names properly upon query.
Set this if a catalog errors out with "dbi: can't find field names" or
the like. The first field should always be B<code>. This is not a DBI
parameter, it is specific to Interchange. All columns must be listed,
in order of their position in the table.

=item NUMERIC

Tells Interchange not to quote values for this field. It allows
numeric data types for SQL databases. It is placed as a
comma-separated field of column names for a table, in no particular
order. This should be defined if a numeric value is used because many
DBD drivers do not yet support type queries.

=item UPPERCASE

Tells Interchange to force field names to UPPER case for row accesses
using the C<[item-data ...]>, C<[loop-data ...]>, C<[item-field ...>,
etc. Typically used for Oracle and some other SQL implementations.

=item DELIMITER

A Interchange delimiter type, either TAB,CSV,PIPE,%%,LINE or the
corresponding numeric type. The default for SQL databases is TAB. Use
DELIMITER if another type will be used to import. This is not a DBI
parameter. It is specific to Interchange.

=item KEY

The keying default of C<code> in the first column of the database can
be changed with the KEY directive. Don't use this unless prepared to
alter all searches, imports, and exports accordingly. It is best to
just accept the default and make the first column the key for any
Interchange database.

=item ChopBlanks,LongReadLen,LongTruncOK,RaiseError, etc.

Sets the corresponding DBI attribute. Of particular interest is
C<ChopBlanks>, which should be set on drivers which by default return
space-padded fixed-length character fields (Solid is an example).

The supported list as of this release of Interchange is:

  Chop  CompatMode
  LongReadLen
  LongTruncOk
  PrintError
  RaiseError
  Warn

lanks

Issue the shell command C<perldoc DBI> for more information.

=back

Here is an example of a completely set up DBI database on mySQL, using
a comma-separated value input, setting the DBI attribute
C<LongReadLen> to retrieve an entire field, and changing some field
definitions from the default char(128):

 Database   products  products.csv  dbi:mysql:minivend
 Database   products  USER          minivend
 Database   products  PASS          nevairbe
 Database   products  DELIMITER     CSV

 # Set a DBI attribute
 Database   products  LongReadLen   128

 # change some fields from the default field type of char(128)
 # Only applies if Interchange is importing from ASCII file
 # If you set a field to a numeric type, you must set the
 # NUMERIC attribute
 Database   products  COLUMN_DEF    "code=char(20) NOT NUL primary key"
 Database   products  COLUMN_DEF    price=float, discount=float
 Database   products  COLUMN_DEF    author=char(40), title=char(64)
 Database   products  COLUMN_DEF    nontaxable=char(3)
 Database   products  NUMERIC       price
 Database   products  NUMERIC       discount

mySQL, DBI, and DBD::mysql must be completely installed and tested,
and have created the database C<minivend>, for this to work.
Permissions are difficult on mySQL. if having trouble, try starting
the mySQL daemon with C<safe_mysqld --skip-grant-tables &> for testing
purposes.

To change to ODBC, the only changes required might be:

   Database products  DSN         dbi:ODBC:TCP/IP localhost 1313
   Database products  ChopBlanks  1

The DSN setting is specific to a ODBC setup. The C<ChopBlanks> setting
takes care of the space-padding in Solid and some other databases. It
is not specific to ODBC. Once again, DBI, DBD::ODBC, and the
appropriate ODBC driver must be installed and tested.

=head2 SQL Access Methods

An Interchange SQL database can be accessed with the same tags as any
of the other databases can. Arbitrary SQL queries can be passed with
the C<[query sql="SQL STATEMENT"]> MML tag.

=head2 Importing from an ASCII File

When importing a file for SQL, Interchange by default uses the first
column of the ASCII file as the primary key, with a C<char(16)> type,
and assigns all other columns a C<char (128)> definition. These
definitions can be changed by placing the proper definitions in
COLUMN_DEF Database directive attribute:

 Database  products  COLUMN_DEF  price=char(20), nontaxable=char(3)

This can be set as many times as desired, if it will not fit on the
line.

 Database  products  COLUMN_DEF  price=char(20), nontaxable=char(3)
 Database  products  COLUMN_DEF  description=char(254)

To create an index automatically, append the information when the
value is in quotes:

 Database  products  COLUMN_DEF  "code=char(14) primary key"

The field delimiter to use is TAB by default, but can be changed with
the Database DELIMITER directive:

 Database  products products.csv dbi:mSQL:minivend:localhost:1114
 Database  products DELIMITER  CSV

To create other secondary keys to speed sorts and searches, do so in
the COLUMN_DEF:

 Database  products COLUMN_DEF  "author=char(64) secondary key"

Or use external database tools. NOTE: Not all SQL databases use the
same index commands.

To use an existing SQL database instead of importing, set the NoImport
directive in catalog.cfg to include any database identifiers not to be
imported:

   NoImport  products inventory

B<WARNING: >If Interchange has write permission on the products
database, be careful to set the NoImport directive or create the
proper .sql file. If that is not done, and the database source file is
changed, the SQL database could be overwritten. In any case, always
back up the database before enabling it for use by Interchange.

=head1 THE SEARCH ENGINE

Interchange implements a search engine which will search the product
database (or any other file) for items based on customer input. It
uses either forms or link-based searches that are called with the
special page name C<scan>. The search engine uses many special
Interchange tags and variables.

If the search is implemented in a link or a form, it will always
display formatted results on the results page, an Interchange page
that uses some combination of the C<[search-region]>,
C<[search-list]>, C<[more-list]>, C<[more]>, and other Interchange
tags to format and display the results. The search results are usually
a series of product codes/SKUs or other database keys, which are then
iterated over similar to the C<[item-list]>.

B<Note: >Examples of search forms and result pages are included in the
demos.

Two search engine interfaces are provided, and five types of searching
are available. The default is a text-based search of the first
products database source file (i.e., products.txt). A binary search of
a dictionary-ordered file can be specified. An optional Glimpse search
is enabled by placing the command specification for Glimpse in the
C<catalog.cfg> directive C<Glimpse>. There is a range-based search,
used in combination with one of the above. And finally, there is a
fully-coordinated search with grouping.

The default, a text based search, sequentially scans the lines in the
target file. By default it returns the first field (delineated by the
delimiter for that database, for every line matching the search
specification. This corresponds to the product code, which is then
used to key specific accesses to the database.

The text-based search is capable of sophisticated field-specific
searches with fully-independent case-sensitivity, substring, and
negated matching.

=head2 The Search Form

A number of variables can be set on search forms to determine which
search will be used, what fields in the database it will search, and
what search behavior will be.

Here is a simple search form:

 <FORM ACTION="[area search]" METHOD=POST>
 <INPUT TYPE="text" SIZE="30" NAME="mv_searchspec">
 <INPUT TYPE="submit" VALUE="Search">
 </FORM>

When the "Search" submit button is pressed (or <ENTER> is pressed),
Interchange will search the C<products.txt> file for the string
entered into the text field C<mv_searchspec>, and return the product
code pertaining to that line.

The same search for a fixed string, say "shirt," could be performed
with the use of a hot link, using the special scan URL:

 [page search="se=shirt"]See our shirt collection![/page]

The default is to search every field on the line. To match on the
string "shirt" in the product database field "description," modify the
search:

 <INPUT TYPE="hidden" NAME="mv_search_field" VALUE="description">

In the hot-linked URL search:

 [page search="
               se=shirt
               sf=category
           "]See our shirt collection![/page]

To let the user decide on the search parameters, use checkboxes or
radiobox fields to set the fields:

   Search by author
      <INPUT TYPE="checkbox" NAME="mv_search_field" VALUE="author">
   Search by title
       <INPUT TYPE="checkbox" NAME="mv_search_field" VALUE="title">

Fields can be stacked. If more than one is checked, all checked fields
will be searched.

=head2 Glimpse

To use the Glimpse search, the Glimpse index must be built based on
files in the ProductDir, or wherever the files to be searched will be
located. If Interchange was installed in the default
C</usr/local/lib/minivend>, the command line to build the index for
the products file would be:

   chdir products
   glimpseindex -b -H . products.txt

There are several ways to improve search speed for large catalogs. One
method that works well for large C<products.txt> files is to split the
C<products.txt> file into small index files (in the example, 100
lines) with the split(1) UNIX/POSIX command. Then, index it with
Glimpse:

   split -100 products.txt index.txt.
   glimpseindex -H /usr/local/lib/minivend/products index.txt.*

This will dramatically increase search speeds for large catalogs, at
least if the search term is relatively unique. If it is a common
string, in a category search, for example, it is better to use the
text-based search.

To search for numbers, add the C<-n> option to the Glimpse command
line.

B<Note: >A large catalog is one of more than several thousand items;
smaller ones have acceptable speed in any of the search modes.

If the Glimpse executable is not found at Interchange startup, the
Glimpse search will be disabled and the regular text-based search used
instead.

There are several things to watch for while using Glimpse, and a
liberal dose of the Glimpse documentation is suggested. In particular,
the spelling error capability will not work in combination with the
field-specific search. Glimpse selects the line, but Interchange's
text-based search routines disqualify it when checking to see if the
search string is within one of the specified fields.

To use field-specific searching on Glimpse, tell it what the field
names are. If the search is on the products database (file), nothing
is needed for the default is to use the field names from the products
database. If it is some other field layout, specify the file to get
the field names from with C<mv_field_file> (ff).

=head2 Fast Binary Search

Fast binary searching is useful for scanning large databases for
strings that match the beginning of a line. They use the standard Perl
module Search::Dict, and are enabled through use of the
C<mv_dict_look>, C<mv_dict_end>, C<mv_dict_limit>, C<mv_dict_fold>,
and C<mv_dict_order> variables.

The field to search is the first field in the file, the product code
should be in the second field, delimited by TAB. Set the
C<mv_return_fields=1> to return the product code in the search.

The search must be done on a dictionary-ordered pre-built index, which
can be produced with the database INDEX modifier. See Dictionary
indexing with INDEX.

If using the C<mv_dict_look> parameter by itself, and the proper index
file is present, Interchange will set the options:

   mv_return_fields=1
   mv_dict_limit=-1

This will make the search behave much like the simple search described
above, except it will be much faster on large files and will match
only from the beginning of the field. Here is an example. A C<title>
index has been built by including in C<catalog.cfg>:

   Database   products   INDEX    title

B<Note: >The ASCII source file must be "touched" to rebuild the index
and the database.

Now, specify in a form:

   <FORM ACTION="[process href=search]" METHOD=POST>
   <INPUT TYPE=hidden NAME=mv_dict_limit VALUE=title>
   <INPUT NAME=mv_dict_look>
   </FORM>

or in a URL:

   [page search="dl=Van Gogh/di=title"]

This search is case-sensitive. To do the same thing
case-insensitively:

   Database   products   INDEX    title:f

   <FORM ACTION="[process href=search]" METHOD=POST>
   <INPUT TYPE=hidden NAME=mv_dict_limit VALUE=title>
   <INPUT TYPE=hidden NAME=mv_dict_fold  VALUE=1>
   <INPUT NAME=mv_dict_look>
   </FORM>

   [page search="dl=Van Gogh/di=title/df=1"]

=head2 Coordinated and Joined Searching

Interchange will do a complete range of tests on individual columns in
the database. To use this function, set C<mv_coordinate> to Yes
(co=yes in the one-click syntax). In order to use coordinated
searching, the number of search fields must equal the number of search
strings.

To make sure that is the case, use the C<mv_search_map> variable. It
allows variables to be mapped to others in the search specification.
For example:

   <INPUT TYPE=hidden NAME=mv_search_map VALUE="
       mv_searchspec=search1
       mv_searchspec=search2
       mv_searchspec=search3
       ">
   <INPUT TYPE=hidden NAME=mv_search_field VALUE=title>
   <INPUT TYPE=hidden NAME=mv_search_field VALUE=artist>
   <INPUT TYPE=hidden NAME=mv_search_field VALUE=category>
   Artist: <INPUT NAME=search1 VALUE="">
   Title:  <INPUT NAME=search2 VALUE="">
   Genre:  <INPUT NAME=search3 VALUE="">

Even if the user leaves one blank, the search will work.

Leading/trailing whitespace is stripped from all lines in the
C<mv_search_map> variable, so it can be positioned as shown for
convenience.

Coordinated searches may be joined with the output of another table if
set one of the C<mv_search_field> values is set to a C<table:column>
pair. Note that this will slow down large searches considerably unless
there is another search specification, as the database must be
accessed for every search line If there is a search field that
qualifies for a regular expression search function, or conducting a
binary search with C<mv_dict_look>, or are not doing an C<OR> search,
the penalty should not be too great as only matching lines will cause
an access to the database.

Individual field operations can then be specified with the
C<mv_column_op> (or op) parameter. The operations include:

   operation            string     numeric   equivalent
   ---------
   equal to               eq         ==           =
   not equal              ne         !=           <>
   greater than           gt         >
   less than              lt         <
   less than/equal to     le         <=
   greater than/equal to  ge         >=
   regular expression     rm                       =~ , LIKE
   regular expression NOT rn                       !~
   exact match            em

An example:

   [page scan
           co=yes
           sf=title
           se=Sunflowers
           op=em
           sf=artist
           se=Van Gogh
           op=rm          ] Sunflowers, Van Gogh [/page]

   [page search="
           co=yes

           sf=title
           se=Sunflowers
           nu=0
           op=!~

           sf=artist
           se=Van Gogh
           op=rm
           nu=0

           sf=inventory:qty
           se=1
           op=>=
           nu=1
       "] Any in stock except Sunflowers, Van Gogh [/page]

Note that in the second example, nu=0 must be specified even though
that is the default. This is to set the proper correspondence. To
avoid having to do this, use Interchange's option array feature:

   [page search.0="
                   sf=title
                   se=Sunflowers
                   op=!~
               "
         search.1="
                   sf=artist
                   se=Van Gogh
               "
         search.2="
                   sf=inventory:qty
                   se=1
                   op=>=
                   nu=1
               "
       ] Any in stock except Sunflowers, Van Gogh [/page]

The C<co=yes> is assumed when specifying a multiple search.

The second search will check the stock status of the painting provided
there is an C<inventory> table as in some of the Interchange demo
catalogs. If the C<qty> field is greater than or equal to 1, the
product will be picked. If out of stock, it will not be found.

It always helps to have an C<rm> type included in the search. This is
used to pre-screen records so that database accesses only need be made
for already-matching entries. If accesses must be made for every
record, large searches can get quite slow.

=head2 Specifying a Text-Based Search with SQL-Like Syntax

If Jochen Wiedmann's C<SQL::Statement> module is installed, a SQL
syntax can be specified for the text-based search. (This is not the
same as the SQL search, treated below separately. It would work on an
SQL table, but only on the ASCII text source file, not on the actual
database.)

This syntax allows this form setup:

   Artist: <INPUT NAME="artist">
   Title:  <INPUT NAME="title">
   <INPUT TYPE=hidden NAME="mv_sql_query"
           VALUE="
               SELECT code FROM products
               WHERE artist LIKE artist
               AND    title LIKE title">

If the right hand side of an expression looks like a column, i.e., is
not quoted, the appropriate form variable is substituted. (If used in
a one-click, the corresponding scratch variable is used instead.) The
assumption is reversed for the left-hand side. If it is a quoted
string, the column name is read from the passed values. Otherwise, the
column name is literal.

   Search for: <INPUT NAME="searchstring"><BR>
   Search in   <INPUT TYPE="radio" NAME="column" VALUE="title"> title
       <INPUT TYPE="radio" NAME="column" VALUE="artist"> artist
       <INPUT TYPE=hidden NAME="mv_sql_query"
         VALUE="SELECT code FROM products WHERE 'column' LIKE searchstring">

Once again, this does not conduct a search on an SQL database, but
formats a corresponding text-based search. Parentheses will have no
effect, and an OR condition will cause all conditions to be OR. The
searches above would be similar to:

   [page search="
               co=yes
               sf=artist
               op=rm
               se=[value artist]
               sf=title
               op=rm
               se=[value title]
           "  ]
       Search for [value artist], [value title]
   [/page]

   [page search="
               co=yes
               sf=[value column]
               op=rm
               se=[value searchstring]
           "  ]
   Search for [value searchstring]
          in  [value column]
   [/page]

=head2 Range Searching

Range searching allows qualification of search returns with a field
that must be within a certain numeric or alphanumeric range. To use
it, set the C<mv_range_look> variable to the products database field,
or a column/field number for another file. Then, set the corresponding
C<mv_range_min> and C<mv_range_max> variables with a selectable field.

   <INPUT TYPE="hidden" NAME="mv_range_look" VALUE="price">
       Search on Price
   Min <SELECT NAME="mv_range_min">
            <OPTION value=0 SELECTED> Free
            <OPTION value=1000000> $1,000,000
            <OPTION value=10000000> $10,000,000
            <OPTION value=20000000> $20,000,000
            <OPTION value=40000000> $40,000,000
       </SELECT><BR>
   Max <SELECT NAME="mv_range_max">
           <OPTION value=0 SELECTED> no object
           <OPTION value=1000000> $1,000,000
           <OPTION value=10000000> $10,000,000
           <OPTION value=20000000> $20,000,000
           <OPTION value=40000000> $40,000,000
       </SELECT>

The value of 0 for C<mv_range_max> is equivalent to infinity if doing
a numeric search. This makes it impossible to search for a ceiling of
0 with a negative C<mv_range_min>.

The fields are stackable, so more than one range to check can be set.
The order is significant, in the sense that the array of field names
and minimum/maximum values must be kept in order to achieve
correspondence.

The optional C<mv_range_alpha> specification allows alphanumeric range
matching for the corresponding field. If it is set, and the fields are
stacked, they must all be set. The C<mv_case> field does apply if it
is set. Otherwise, the comparison is without regard to case.

If ONLY a range search is required, all lines with
C<mv_return_all>=yes must be selected in order to make the search
operate. Range-only searches will be quite slow for large databases
since every line must be scanned. It should be quite usable for
catalogs of less than 10,000 items in size on a fast machine. Using it
in combination with another search technique (in the same query) will
yield faster search returns.

=head2 One-Click Searches

Interchange allows a search to be passed in a URL, as shown above.
Just specify the search with the special page parameter search or
special page C<scan>. Here is an example:

    [page search="
               se=Impressionists
               sf=category
           "]
       Impressionist Paintings
    [/page]

This is the same:

    [page scan se=Impressionists/sf=category]
       Impressionist Paintings
    [/page]

Here is the same thing from a home page (assuming /cgi-bin/vlink is
the CGI path for Interchange's vlink):

    <A HREF="/cgi-bin/vlink/scan/se=Impressionists/sf=category">
       Impressionist Paintings
    </A>

The two-letter abbreviations are mapped with these letters:

 ac  mv_all_chars
 bd  mv_base_directory
 bs  mv_begin_string
 co  mv_coordinate
 cs  mv_case
 cv  mv_verbatim_columns
 de  mv_dict_end
 df  mv_dict_fold
 di  mv_dict_limit
 dl  mv_dict_look
 DL  mv_raw_dict_look
 do  mv_dict_order
 dr  mv_record_delim
 em  mv_exact_match
 er  mv_spelling_errors
 ff  mv_field_file
 fi  mv_search_file
 fm  mv_first_match
 fn  mv_field_names
 hs  mv_head_skip
 ix  mv_index_delim
 lb  mv_search_label
 lo  mv_list_only
 lr  mv_search_line_return
 md  mv_more_decade
 ml  mv_matchlimit
 mm  mv_max_matches
 MM  mv_more_matches
 mp  mv_profile
 ms  mv_min_string
 ne  mv_negate
 ng  mv_negate
 np  mv_nextpage
 nu  mv_numeric
 op  mv_column_op
 os  mv_orsearch
 ra  mv_return_all
 rd  mv_return_delim
 rf  mv_return_fields
 rg  mv_range_alpha
 rl  mv_range_look
 rm  mv_range_min
 rn  mv_return_file_name
 rr  mv_return_reference
 rs  mv_return_spec
 rx  mv_range_max
 SE  mv_raw_searchspec
 se  mv_searchspec
 sf  mv_search_field
 sg  mv_search_group
 si  mv_search_immediate
 sp  mv_search_page
 sq  mv_sql_query
 sr  mv_search_relate
 st  mv_searchtype
 su  mv_substring_match
 tc  mv_sort_command
 td  mv_table_cell
 tf  mv_sort_field
 th  mv_table_header
 to  mv_sort_option
 tr  mv_table_row
 un  mv_unique
 va  mv_value

These can be treated just the same as form variables on the page,
except that they can't contain a new line. If using the multi-line
method of specification, the characters will automatically be escaped
for a URL.

IMPORTANT NOTE: An incompatibility in earlier Interchange catalogs is
specifying C<[page scan/se=searchstring]>. This is interpreted by the
parser as C<[page scan/se="searchstring"]> and will cause a bad URL.
Change this to C<[page scan se=searchstring]>, or perhaps better yet:

   [page search="
                   se=searchstring
           "]

cause a bad URL. Change this to C<[page scan se=searchstring]>.

A one-click search may be specified in three different ways.

=over 4

=item Original

To do an OR search on the fields category and artist for the strings
"Surreal" and "Gogh," while matching substrings, do:

 [page scan se=Surreal/se=Gogh/os=yes/su=yes/sf=artist/sf=cat    Van Gogh -- compare to surrealists
 [/page]

gory]

In this method of specification, to replace a / (slash) in a file name
(for the sp, bd, or fi parameter), the shorthand of :: must be used,
i.e., sp=results::standard. (This may not work for some browsers, so
put the page in the main pages directory or define the page in a
search profile.)

=item Multi-Line

Specify parameters one to a line, as well.

    [pag        se="Van Gogh"
        sp=lists/surreal
        os=yes
        su=yes
        sf=artist
        sf=category
    ] Van Gogh -- compare to surrealists [/page]

 scan

Any "unsafe" characters will be escaped. To search for trailing spaces
(unlikely), quote.

=item Ampersand

Substitute & for / in the specification and be able to use / and
quotes and spaces in the specification.

 [page href=scan se="Van Gogh"&sp=lists/surreal&os=yes&su=yes&sf=artist&sf=cat    Van Gogh -- compare to surrealists
 [/page]

gory]

Any "unsafe" characters will be escaped.

=back

=head2 Setting Display Options with mv_value

A value can be specified that will be set in the link with the
C<mv_value> parameter. It takes an argument of C<var=value>, just as
setting a normal variable in an Interchange profile. Actually
C<mv_value> is a misnomer, it will almost never be used in a form
where variable values can be set. Always specify it in a one-click
search with C<va=var=value>. Example:

   [page href=scan
         arg="se=Renaissance
              se=Impressionists
              va=category_name=Renaissance and Impressionist Paintings
              os=yes"]Renaissance and Impressionist Paintings[/page]

Display the appropriate category on the search results page with
C<[value category_name]>.

=head2 In-Page Searches

To specify a search inside a page with the C<[search-region
parameters*]> tag. The parameters are the same as the one-click
search, and the output is always a newline-separated list of the
return objects, by default, a series of item codes.

The C<[loop ...]> tag directly accepts a search parameter. To search
for all products in the categories "Americana" and "Contemporary," do:

   [loop search="
       se=Americana
       se=Contemporary
       os=yes
       sf=category9
       "]
   Artist: [loop-field artist]<BR>
   Title: [loop-field title]<P>
   [/loop]

The advantage of the in-page search is that searches can be embedded
within searches, and there can be straight unchanging links from
static HTML pages.

To place an in-page search with the full range of display in a normal
results page, use the C<[search-region]> tag the same as above, except
that C<[search-list]>, C<[more-list]>, and C<[more]> tags can be
placed within it. Use them to display and format the results,
including paging. For example:

   [search-region  more=1
                   search="
                        se=Americana
                        sf=category
                        ml=2
                   "]
   [more-list][more][/more-list]
   [search-list]
   <A MV="page [item-code]" HREF="flypage.html">
       [item-field title]<A>, by [item-field artist]
   [/search-list]
   [no-match]
       Sorry, no matches for [value mv_searchspec].
   [/no-match]
   [/search-region]

To use the same page for search paging, make sure to set the
C<sp=page> parameter.

=head2 Search Profiles

An unlimited number of search profiles can be predefined that reside
in a file or files. To use this, make up a series of lines like:

 mv_search_field=artist
mv_search_field=category
mv_orsearch=yes

These correspond to the Interchange search variables that can be set
on a form. Set it right on the page that contains the search.

 [set artist_profile]
mv_search_field=artist
mv_search_field=category
mv_orsearch=yes
[/set]

This is the same:

 [set artist_profile]
sf=artist
sf=category
os=yes
[/set]

Then, in the search form, set a variable with the name of the profile:

   <INPUT TYPE=hidden NAME=mv_profile VALUE=artist_profile>

In a one-click search, use the C<mp> modifier:

 [page scan se=Leonardo/mp=artist_profile]A left-handed artist[/page]

They can also be placed in a file. Define the file name in the
C<SearchProfile> directive. The catalog must be reconfigured for
Interchange to read it. The profile is named by placing a name
following a __NAME__ pragma:

 __NAME__ title_search

The __NAME__ must begin the line, and be followed by whitespace and
the name.

The special variable C<mv_last> stops interpretation of search
variables. The following variables are always interpreted:

   mv_dict_look
   mv_searchspec
   mv_range_look
   mv_range_min
   mv_range_max

Other than that, if C<mv_last> is set in a search profile, and there
are other variables on the search form, they will not be interpreted.

To place multiple search profiles in the same file, separate them with
__END__, which must be on a line by itself.

=head2 Search Reference

The supplied C<simple/srchform.html> and C<simple/results.html> pages
show example search forms. Modify them to present the search in any
way desired. Be careful to use the proper variable names for passing
to Interchange. It is also necessary to copy the hidden variables
as-is. They are required to interpret the request as a search.

B<Note: >The following definitions frequently refer to field name and
column and column number. All are the references to the columns of a
searched text file as separated by delimiter characters.

The field names can be specified in several ways.

=over 4

=item ProductFiles

If the file to be searched is left empty in the search form or
definition (it is set with C<mv_search_file (fi)>), the text files
associated with the products databases will be searched, and field
names are already available as named in the first line of the file(s).
This is defined to be C<products.txt> in the Interchange
demonstrations.

Be Careful if using SQL! If the database is change and not exporte
with C<[tag export products][/tag]>, searches will not be successful.

=item Other database files

If the file or files to be searched are ASCII delimited files, and
have field names specified on the first line of the file, Interchange
will read the first line (of the first file) and determine the field
names.

=item Other files

If the file or files to be searched are ASCII delimited files, but
don't have field names specified on the first line of the file, set
the variable C<mv_field_names> to a comma-separated list of field
names as they will be referenced.

=back

Fields can also always be specified by an integer column number, with
0 as the first column.

=over 4

=item mv_all_chars

Scan abbreviation: ac=[1|0]. Set this if searching is anticipated for
lots of punctuation characters that might be special characters for
Perl. The characters ()[]\$^ are included.

=item mv_base_directory

Scan abbreviation: bd=/directory/name. In the text search, set to the
directory from which to base file searches. File names without leading
/ characters will be based from there. In the Glimpse search, passed
to Glimpse with the C<-H> option, and Glimpse will look for its
indices there. Default is ProductDir.

If an absolute path directory is used, for security enable it in the
users session with:

    [set /directory/name]1[/set]

This prevents users from setting an arbitrary value and viewing
arbitrary files.

=item mv_begin_string

If this is set, the string will only match if it is at the beginning
of a field. The handling is a bit different for the default AND search
compared to the OR search. With OR searches all words are searched for
from the beginning of the field, with AND searches all are.

This is a multiple parameter. If C<mv_coordinate> is in force, it
should be set as many times as necessary to match the
field/searchstring combination. If set only once, it applies to all
fields. If set more than once but not as many times as the fields, it
will default to off.

=item mv_case

If this item is set to C<No>, the search will return items without
regard to upper or lower case. This is the default. Set to C<Yes> if
case should be matched. Implement with a checkbox <INPUT
TYPE=CHECKBOX> field.

If stacked to match the C<mv_search_field> and C<mv_searchspec>
variables, and C<mv_coordinate> is set, it will operate only for the
corresponding field.

=item mv_coordinate

If this item is set to C<Yes>, and the number of search fields equals
the number of search specs, the search will return only items that
match field to spec. (The search specifications are set by stacked
C<mv_searchspec> and C<mv_search_field> variables.)

Case sensitivity, substring matching, and negation all work on a
field-by field basis according to the following:

=over 8

=item

If only one instance of the option is set, it will affect all fields.

If the number of instances of the option is greater than or equal to
the number of search specs, all will be used independently. Trailing
instances will be ignored.

If more than one instance of the options are set, but fewer than the
number of search specifications, the default setting will be used for
the trailing unset options.

If a search specification is blank, it will be removed and all
case-sensitivity/negation/substring options will be adjusted
accordingly.

=back

=item mv_dict_end

If the string at the beginning of a line lexically exceeds this value,
matching will stop. Ignored without C<mv_dict_look>.

=item mv_dict_fold

Make dictionary matching case-insensitive. Ignored without
C<mv_dict_look>.

=back

B<Note: >This is the reverse sense from C<mv_case>.

=over 4

=item mv_dict_limit

Automatically set the limiting string (mv_dict_end) to be one
character greater than the mv_dict_look variable, at the character
position specified. A value of 1, for instance, will set the limiting
string to "fprsythe" if the value of C<mv_dict_look> is "forsythe". A
useful value is -1, which will increment the last character (setting
the mv_dict_end to "forsythf" in our example). This prevents having to
scan the whole file once a unique match is found.

=back

B<Note: >The order of this and the C<mv_dict_end> variable is
significant. Each will overwrite the other.

=over 4

=item

If this is set to a non-numeric value, an automatic mode is entered
which looks for a dictionary-indexed file that corresponds to the file
name plus C<.field>, where C<field> is whatever C<mv_dict_limit> is
set to. The actual value of mv_dict_limit is set to C<-1>. If the file
does not exist, the original file is silently used. Also, the value of
C<mv_return_fields> is set to C<1> to correspond to the location of
the key in the auto-indexed file.

To illustrate:

    <INPUT TYPE=hidden NAME=mv_dict_limit  VALUE=cat    <INPUT TYPE=hidden NAME=mv_search_file VALUE="products.txt">

gory>

is equal to:

    <INPUT TYPE=hidden NAME=mv_dict_limit    VALUE    <INPUT TYPE=hidden NAME=mv_search_file   VALUE="products.txt.category">
    <INPUT TYPE=hidden NAME=mv_return_fields VALUE="1">

"-1">

The real utility would be in a form construct like

    Sear    <SELECT NAME=mv_dict_limit>
    <OPTION> author
    <OPTION> title
    </SELECT> beginning with <INPUT NAME=mv_dictlook>

h for

which would allow automatic binary search file selection.

Combined with the C<INDEX> attribute to the Database directive, this
allows fast binary search qualification combined with regular
C<mv_searchspec> text searches.

=back

=over 4

=item mv_dict_look

The string at which to begin matching at in a dictionary-based search.
If not set, the C<mv_dict_end>, C<mv_dict_fold>, and C<mv_dict_case>
variables will be ignored. May be set in a search profile based on
other form variables.

=item mv_dict_order

Make dictionary matching follow dictionary order, where only word
characters and whitespace matter. Ignored without C<mv_dict_look>.

=item mv_doit

This must be set to C<search> to make this a search page.

=item mv_exact_match

Normally Interchange searches match words, as opposed to sentences.
This behavior can be overridden with C<mv_exact_match>, which when set
will place quotes around any value in C<mv_searchspec> or
C<mv_dict_look>.

=item mv_field_names

Deprecated in favor of in-list sorting. Defines the field names for
the file being searched. This guarantees that they will be available,
and prevents a disk access if using named fields on a search file
(that is not the product database ASCII source, where field names are
already known). This must be exactly correct, or it will result in
anomalous search operation. Usually passed in a hidden field or search
profile as a comma-separated list.

=back

B<Note: >Use this on the product database only if planning on both
pre-sorting with C<mv_sort_field> and then post-sorting C<with
[sort]field:opt[/sort]>.

=over 4

=item mv_first_match

Normally Interchange will return the first page of a search. If this
variable is set, it will start the search return at the match
specified, even if there is only one page. If set to a value greater
than the number of matches, it will act as if no matches were found.

=item mv_head_skip

Normally Interchange searches all lines of an index/product file but
the first. Set this to the number of lines to skip at the beginning of
the index. Default is 1 for the text search, which skips the header
line in the product file. Default is 0 for a Glimpse search.

=item mv_index_delim

Sets the delimiter for counting fields in a search index. The default
is TAB.

=item mv_matchlimit

The page size for matches that are returned. If more matches than
mv_matchlimit are found, the search paging mechanism will be employed
if the proper C<[more-list]> is present. Can be implemented as a
scrolling list (INPUT TYPE=SELECT) or radiobox (INPUT TYPE=RADIO)
field.

=item mv_max_matches

The maximum number of records that will be returned in a search.
Default is 2000. This only applies to Glimpse. Use C<mv_matchlimit> to
set the search page size.

=item mv_min_string

Sets the minimum size of a search string for a search operation.
Default is 4 for the Glimpse search, and 1 for the text search.

=item mv_negate

Specifies that records NOT matching the search criteria will be
returned. Default is no. It is not operative for the Glimpse search.

If stacked to match the C<mv_search_field> and C<mv_searchspec>
variables, and C<mv_coordinate> is set, it will operate only for the
corresponding field.

=item mv_orsearch

If this item is set to C<Yes>, the search will return items matching
any of the words in C<searchspec>. The default is No.

=item mv_profile

Selects one of the pre-defined search specifications set by the
C<SearchProfile> directive. If the special variable within that file,
C<mv_last>, is defined, it will prevent the scanning of the form input
for further search modifications. The values of C<mv_searchspec> and
C<mv_dict_look> are always scanned, so specify this to do the
equivalent of setting multiple checkboxes or radioboxes with one
click, while still reading the search input text.

=item mv_range_alpha

Sets the type of match, numeric or alphanumeric, for the range search
in its corresponding range field. The search will return true,
assuming it is greater than the C<mv_range_min> specification, if the
field searched is less than or equal to C<mv_range_max>, in an
alphanumeric sense.

=item mv_range_look

This sets a field to scan for a range of numbers. It must be
accompanied with corresponding C<mv_range_min> and C<mv_range_max>
variables. It can be specified with either a field name or a column
number.

=item mv_range_max

Sets the high bound for the range search in its corresponding range
field. The search will return true, assuming it is greater than the
C<mv_range_min> specification, if the field searched is less than or
equal to C<mv_range_max>. To set the bound at infinity, or whatever
your integer limit is, set C<mv_range_min> to 0.

=item mv_range_min

Sets the low bound for the range search in its corresponding range
field. The search will return true, assuming it is less than the
C<mv_range_max> specification, if the field searched is less than or
equal to C<mv_range_min>.

=item mv_record_delim

Sets the delimiter for counting records in a search index. The default
is newline, which works for the products and most line-based index
files.

=item mv_return_fields

The fields that should be returned by the match, specified either by
field name or by column number. Specify 0 as the first field to be
returned if searching the products database, since that is the key for
accessing database fields.

=item mv_return_spec

Returns the string specified as the search (i.e., the value of
C<mv_searchspec>) as the one and only match. Typically used in a
SKU/part number search.

=item mv_search_field

The field(s) to be searched, specified either by column name or by
column number.

If the number of instances matches the number of fields specified in
the C<mv_searchspec> variable and C<mv_coordinate> is set to true,
each search field (in order specified on the form) will be matched
with each search spec (again in that order).

=item mv_search_file

In the text search, set this variable to the file(s) to be scanned for
a match. The default, if not set, is to scan the default ProductFiles
(i.e., products.txt). If set multiple times in a form (for a text
search), will cause a search all the files. One file name per
instance.

In the Glimpse search, follows the Glimpse wildcard-based file name
matching scheme. Use with caution and a liberal dose of the Glimpse
man page.

=item mv_search_match_count

Set by the search to indicate the total number of matches found.

=item mv_search_over_msg

The message that should be displayed if there is an overflow condition
(C<mv_matchlimit> is exceeded). Overrides the SearchOverMsg directive.
It is cleared by Interchange if there is no overflow. Somewhat
deprecated by match paging.

=item mv_search_page

The Interchange-style name of the page that should display the search
results. Overrides the C<FrameSearchPage> directive, and the default
value of C<search>.

=item mv_searchspec

The actual search string that is typed in by the customer. It is a
text INPUT TYPE=TEXT field, or can be put in a select (drop-down) list
to enable category searches. If multiple instances are found, they
will be concatenated just as if multiple words had been placed in a
text field.

The user can place quotes around words to specify that they match as a
string. To enable this by default, use the C<mv_exact_match> variable.

If C<mv_dict_look> has a value, and C<mv_searchspec> does not, then
C<mv_searchspec> will be set to the value of C<mv_dict_look>.

If the number of instances matches the number of fields specified in
the C<mv_search_field> variable and C<mv_coordinate> is set to true,
each search field (in order specified on the form) will be matched
with each search spec (again in that order).

=item mv_searchtype

If set to Glimpse, selects the Glimpse search (if Glimpse is defined).

If set to db, iterates over every row of the database (not the
associated text source file).

If set to sql, same as C<db>.

If set to text, selects the text-based search.

When using C<st=db>, returned keys may be affected by
C<TableRestrict>. See C<CATALOG.CFG>.

Defaults to text if Glimpse is not defined; defaults to Glimpse if it
is defined. This can allow use of both search types if that is
desirable. For instance, searching for very common strings is better
done by the text-based search. An example might be searching for
categories of items instead of individual items.

=item mv_sort_field

The file field(s) the search is to be sorted on, specified in one of
two ways. If the file(s) to be searched have a header line (the first
line) that contains delimiter-separated field names, it can be
specified by field name. It can also be specified by column number
(the code or key is specified with a value of 0, for both types).
These can be stacked if coming from a form or placed in a single
specification separated by commas.

=back

B<NOTE FOR ADVANCED USERS: >If specifying a sort for the product
database, C<mv_field_names> must be specified if doing a
fieldname-addressed post-sort.

=over 4

=item mv_sort_option

The way that each field should be sorted. The flags are C<r>, C<n>,
and C<f>, reverse, numeric, and case-insensitive respectively. These
can be stacked if coming from a form or placed in a single
specification separated by commas. The stacked options will be applied
to the sort fields as they are defined, presuming those are stacked.

=item mv_spelling_errors

The number of spelling errors that will be tolerated. Ignored unless
using Glimpse. For a large catalog, limit this to two.

=item mv_substring_match

If C<mv_substring_match> is set to C<Yes>, matches on substrings as
well as whole words. Typically set this for dictionary-based searches.

If stacked to match the C<mv_search_field> and C<mv_searchspec>
variables and C<mv_coordinate> is set, it will operate only for the
corresponding field.

=item mv_unique

If set to a true value, causes the sort to return only unique results.
This operates on whatever the search return is, as defined by
C<mv_return_fields>.

=item mv_value

This is normally only used in the one-click search (va=var=value). It
allows setting of a session variable based on the clicked link, which
makes for easy definition of headers and other display choices. (If
had trouble using C<mv_searchspec> for this before, this is what is
needed.)

=back

=head2 The Results Page

Once a search has been completed, there needs to be a way of
presenting the output. By default, the C<SpecialPage> search is used.
It is set to C<results> in the distribution demo, but any number of
search pages can be specified by passing the value in the search form
specified in the variable C<mv_search_page>.

On the search page, some special Interchange tags are used to format
the otherwise standard HTML. Each of the iterative tags is applied to
every code returned from the search. This is normally the product
code, but could be a key to any of the arbitrary databases. The value
placed by the C<[item-code]> tag is set to the first field returned
from the search.

The basic structure looks like this:

 [search-region]
[search-list]
    your iterating code, once for each match
[/search-list]
[no-match]
    Text / tags to be output if no matches found (optional but recommended)
[/no-match]
[more-list]
    More / paging area (optional)
[/more-list]
[/search-region]

TIP FOR MV3 PORTS: A C<[search-list][/search-list]> must always be
surrounded by a C<[search-region][/search-region]> pair. This is a
change from Interchange 3.

=over 4

=item [search-list]

Starts the representation of a search list. Interchange tags can be
embedded in the search list, yielding a table or formatted list of
items with part number, description, price, and hyperlinks to order or
go to its catalog page.

The example tags shown have an C<item-> prefix, which is the default.
Set any prefix desired with the C<prefix> parameter to
C<[search-region]>:

    [search-region pref    [search-list]
        SKU:   [my-code]
        Title: [my-data products title]
    [/search-list]
    [/search-region]

x=my]

The standard set of Interchange iterative ITL tags are available. They
are interpolated in this order:

        [item-alternate N] true [else] false [/else] [/item-alte        [if-item-param named_field] true [else] false [/else] [/if-item-param]
        [item-param named_field]
        [if-item-pos N] true [else] false [/else] [/if-item-pos]
        [item-pos N]
        [if-item-field products_field] true [else] false [/else] [/if-item-field]
        [item-field products_column]
        [item-increment]
        [item-accessories]
        [item-code]
        [item-description]
        [if-item-data table column] true [else] false [/else] [/if-item-data]
        [item-data table column]
        [item-price N* noformat=1*]
        [item-calc] [/item-calc]
        [item-change marker]
            [condition]variable text[/condition]
            true
            [else] false [/else]
        [/item-change marker]
        [item-last] condition [/item-last]
        [item-next] condition [/item-next]

nate]

=back

B<Note: >those that reference the shopping cart do not apply, i.e.,
[item-quantity], [item-modifier ...] and friends.

=over 4

=item [/search-list]

Ends the search list.

=item [no-match]

Starts the region of the search results page that should be returned
if there is no match (and no error) for the search. If this is not on
the page, the special page nomatch will be displayed instead.

=item [/no-match]

Ends the no match region.

=item [sort database:field:option* database:field:option*]

Sorts the search list return based on database fields. If no options
are supplied, sorts according to the return code. See SORTING.

This is slow, and it is far better to pre-sort the return in the
search specification.

=item [item-change marker]

Active only within C<[search-list][/search-list]>.

Along with the companion C<[/item-change marker]>, surrounds a region
which should only be output when a field (or other repeating value)
changes its value. This allows indented lists similar to database
reports to be easily formatted. The repeating value must be a tag
interpolated in the search process, such as C<[item-field field]> or
C<[item-data database field]>.

Of course, this will only work as expected when the search results are
properly sorted.

The C<marker> field is mandatory, and is also arbitrary, meaning that
any marker can be selected as long as it matches the marker associated
with C<[/item-change marker]>. The value to be tested is contained
within a C<[condition]value[/condition]> tag pair. The C<[item-change
marker]> tag also processes an C<[else] [/else]> pair for output when
the value does not change. The tags may be nested as long as the
markers are different.

The following is a simple example for a search list that has a field
C<category> and C<subcategory> associated with each item:

 < <TR><TH>Category</TH><TH>Subcategory</TH><TH>Product</TH></TR>
 [search-list]
 <TR>
    <TD>
         [item-change cat]

         [condition][item-field category][/condition]

                 [item-field category]
         [else]
                 &nbsp;
         [/else]
         [/item-change cat]
    </TD>
    <TD>
         [item-change subcat]

         [condition][item-field subcategory][/condition]

                 [item-field subcategory]
         [else]
                 &nbsp;
         [/else]
         [/item-change subcat]
    </TD>
    <TD> [item-field name] </TD>
 [/search-list]
 </TABLE>

ABLE>

The above should output a table that only shows the category and
subcategory once, while showing the name for every product. (The
C<&nbsp;> will prevent blanked table cells if using a border.)

=item [/item-change marker]

Companion to C<[item-change marker]>.

=item [matches]

Replaced with the range of match numbers displayed by the search page.
Looks something like "1-50". Make sure to insert this item between a
C<[more-list]> and C<[/more-list]> element pair.

=item [more-list next_img* prev_img* page_img* border* border_current*]

Starts the section of the search page which is only displayed if there
are more matches than specified in C<mv_matchlimit>. If there are less
matches than the number in mv_matchlimit, all text/html between the
C<[more_list]> and C<[/more_list]> elements is stripped.

Use in conjunction with the C<[more]> element to place pointers to
additional pages of matches.

If the optional arguments C<next_img>, C<prev_img>, and/or C<page_img>
are present, they represent image files that will be inserted instead
of the standard 'Next,' 'Previous,' and page number. If C<prev_img> is
C<none>, then no previous link will be output. If C<page_img> is
C<none>, then no links to pages of matches will be output. These are
URLs, are substituted for with I<ImageDir> and friends, and will be
encased in IMG tags. Lastly, C<border> is the border number to put.

In addition, if C<page_img> is used, it will be passed an argument of
the digit that is to be represented. This would allow an image
generator program to be used, generating page numbers on the fly. The
C<border> and C<border_selected> values are integers indicating the
border that should be put around images in the C<page_img> selection.
The <border_selected> is used for the current page if set.

\Examples:

C<[more-list next.gif prev.gif page_num.cgi 3]> causes anchors of:

     Previous   <IMG SRC="prev.gif" Bor     Page 1     <IMG SRC="/cgi-bin/page_num.cgi?1">
     Page 2     <IMG SRC="/cgi-bin/page_num.cgi?2">
     Next       <IMG SRC="next.gif" Border=3>

er=3>

C<[more-list next.gif prev.gif page_num.cgi]> causes anchors of:

     Previous   <IMG SRC="prev     Page 1     <IMG SRC="/cgi-bin/page_num.cgi?1">
     Page 2     <IMG SRC="/cgi-bin/page_num.cgi?2">
     Next       <IMG SRC="next.gif">

gif">

C<[more-list next.gif prev.gif 0 0]> causes anchors of:

     Previous   <IMG SRC="prev.gif" Bor     Page 1     <IMG SRC="/cgi-bin/page_num.cgi?1">
     Page 2     <IMG SRC="/cgi-bin/page_num.cgi?2">
     Next       <IMG SRC="next.gif" Border=0>

er=0>

To set custom text for the "Previous" and "Next" usually used, define
the C<next_img>, C<prev_img>, and C<page_img> with
C<[next-anchor][/next-anchor]>, C<[prev-anchor][/prev-anchor]> and
C<[page-anchor][/page-anchor]>. The string $PAGE$ will be replaced
with the page number in the latter. The same example:

    [more-list     [next-anchor] Forward [/next-anchor]
    [prev-anchor] Back [/prev-anchor]
    [page-anchor] Page $PAGE$ [/page-anchor]
    [more]
    [/more-list]

 0 0]

will display C<Forward Page 1 Page 2 Back> for 2 pages.

As shown, pass a 0 for the arguments of each to tell Interchange to
look for the assignments.

If have many pages of matches and don't wish to have all displayed at
once, set C<[decade-next][/decade-next]> and
C<[decade-prev][/decade-prev]>. If set them empty, a search with 31
pages will display pages 21-30 like:

  Previous 1 2 3 4 5 6 7 8 9 10 [more>>] Next

and pages 11-20 like:

  Previous [<<more] 11 12 13 14 15 16 17 18 19 20 [more>>] Next

If set to C<[decade-next](higher)[/decade-next]> and
C<[decade-prev](lower)[/decade-prev]>, the following will be
displayed:

  Previous (lower) 11 12 13 14 15 16 17 18 19 20 (higher) Next

Of course, image-based anchors can be used as well.

=item [/more-list]

Companion to C<[more-list]>.

=item [more]

Inserts a series of hyperlinks that will call up the next matches in a
series. They look like this:

    Previous 1 2 3 4 5 6 Next

The current page will not be a hyperlink. Every time the new link is
pressed, the list is re-built to correspond to the current page. If
there is no C<Next> or C<Previous> page, that link will not be shown.

See the C<fr_resul.html> or C<search.html> files for examples. Make
sure to insert this item between a C<[more-list]> and C<[/more-list]>
element pair.

=item [process-search]

Calls the search with the proper URL, including Interchange session
tags. Used as the ACTION value for the search form.

=item [process-target frame]

Calls the search with the proper URL, including Interchange session
tags. Used as the ACTION value for the search form if the results are
to be targeted to a different window than the one set by SearchFrame
(which is "_self" by default).

=back

=head1 SORTING

Interchange has standard sorting options for sorting the search lists,
loop lists, and item lists based on the contents of database fields.
In addition, it adds list slices for limiting the displayed entries
based on a start value and chunk size (or start and end value, from
which a chunk size is determined). All accept a standard format sort
tag which must be directly after the list call:

   [loop 4 3 2 1]
   [sort -2 +2]
       [loop-code]
   [/loop]

   [search-list]
   [sort products:category:f]
       [item-price] [item-description]<BR>
   [/search-list]

   [item-list]
   [sort products:price:rn]
       [item-price] [item-code]<BR>
   [/item-list]

   [loop search="ra=yes"]
   [sort products:category products:title]
   [loop-field category] [loop-field title] <BR>
   [/loop]

All sort situations, C<[search list]>, C<[loop list]>, C<[tag each
table]>, and C<[item-list]>, take options of the form:

 [sort database:field:option* -n +n =n-n ... ]

=over 4

=item database

The Interchange database identifier. This must be supplied and should
normally be 'products' if using the default name for the database.

=item field

The field (column) of the database to be sorted on.

=item option

None, any, or combinations of the options:

  f   case-insensitive sort (folded) (mutually exclusive  n   numeric order (mutually exclusive of f)
  r   reverse sort

of n)

=item -n

The starting point of the list to be displayed, beginning at 1 for the
first entry.

=item +n

The number of entries to display in this list segment.

=item =n-n

The starting and ending point of the list display. This is an
alternative to C<-n> and +n. They should be specified in only one
form. If both are specified, the last one will take effect.

=item ...

Don't really put C<...> in. This means that many sort levels are
specified. Lots of sort levels with large databases will be quite
slow.

=back

Multiple levels of sort are supported, and database boundaries on
different sort levels can be crossed. Cross-database sorts on the same
level are not supported. If using multiple product databases, they
must be sorted with embedded Perl. This is actually a feature in some
cases, all items in a C<used> database can be displayed before or
after new ones in C<products>.

Examples, all based on the C<simple> demo:

=over 4

=item Loop list

    [loop 00-0011 19-202 34-101 9    [sort products:title]
        [loop-code] [loop-field title]<BR>
    [/loop]

-102]

Will display:

    34-101 Family Po    00-0011 Mona Lisa
    19-202 Radioactive Cats
    99-102 The Art Store T-Shirt

trait

\Alternatively:

    [loop 00-0011 19-202 34-101 9    [sort products:title -3 +2]
        [loop-code] [loop-field title]<BR>
    [/loop]

-102]

\Displays:

    19-202 Radioactiv    99-102 The Art Store T-Shirt

 Cats

The tag C<[sort products:title =3-4]> is equivalent to the above.

=item Search list

A search of all products (i.e.,
http://yoursystem.com/cgi-bin/simple/scan/ra=yes):

    [search    [sort products:artist products:title:rf]
        [item-field artist] [item-field title]<BR>
    [/search-list]

list]

will display:

    Gilded    Grant Wood American Gothic
    Jean Langan Family Portrait
    Leonardo Da Vinci Mona Lisa
    Salvador Dali Persistence of Memory
    Sandy Skoglund Radioactive Cats
    The Art Store The Art Store T-Shirt
    Vincent Van Gogh The Starry Night
    Vincent Van Gogh Sunflowers

Frame

Note the reversed order of the title for Van Gogh and the presence of
the accessory item Gilded Frame at the front of the list. It has no
artist field and, as such, sorts first).

Adding a slice option:

    [search    [sort products:artist products:title:rf =6-10]
        [item-field artist] [item-field title]<BR>
    [/search-list]

list]

will display:

    Sandy Skoglund Radioactiv    The Art Store The Art Store T-Shirt
    Vincent Van Gogh The Starry Night
    Vincent Van Gogh Sunflowers

 Cats

If the end value/chunk size exceeds the size of the list, only the
elements that exist will be displayed, starting from the start value.

=item Shopping cart

    [item    [sort products:price:rn]
        [item-price] [item-code]<BR>
    [/item-list]

list]

will display the items in the shopping cart sorted on their price,
with the most expensive shown first. NOTE: This is based on the
database field and doesn't take quantity price breaks or discounts
into effect. Modifier values or quantities cannot be sorted.

=item Complete database contents

    [tag each pro    [sort products:category products:title]
    [loop-field category] [loop-field title] <BR>
    [/tag]

ucts]

A two level sort that will sort products based first on their
category, then on their title within the category.

=back

Note that large lists may take some time to sort. If a product
database contains many thousands of items, using the C<[tag each
products]> sort is not recommended unless planning on caching or
statically building pages.

=head1 SHIPPING

Interchange has a powerful custom shipping facility that performs UPS
and other shipper lookups, as well as a flexible rule-based facility
for figuring cost by other methods.

=head2 Shipping Cost Database

The shipping cost database (located in ProductDir/shipping.asc) is a
tab-separated ASCII file with six fields: code, text description,
criteria (quantity or weight, for example), minimum number, maximum
number, and cost. None of the fields are case-sensitive.

To define the shipping database in a catalog configuration file, set
the Variable C<MV_SHIPPING> to what would be its contents.

To set the file to be something other than C<shipping.asc> in the
products directory, set the C<Special> directive:

   Special  shipping.asc  /home/user/somewhere/shipping_defs

There are two styles of setting which can be mixed in the same file.
The first is line-based and expects six or more TAB-separated fields.
They would look like:

default No shipping weight  0   99999999    0

upsg    UPS Ground  weight  0   0   e Nothing to ship! upsg    UPS
Ground  weight  0   150 u Ground [default zip 98366] 3.00 upsg    UPS
Ground  weight  150 999999  e @@TOTAL@@ lbs too heavy for UPS

The second is a freeform method with a C<mode: Description text>
introducing the mode line. The special encoding is called out by
indented parameters. The below is identical to the above:

   upsg: UPS Ground
       criteria    weight
       min         0
       max         0
       cost        e Nothing to ship!

       min         0
       max         150
       cost        u
       table       2ndDayAir
       geo         zip
       default_geo 98366
       adder       3

       min         150
       max         999999
       cost        e @@TOTAL@@ lbs too heavy for UPS

The second format has several advantages. Multiple lines can be
spanned with the <<HERE document format, like so:

   upsg: UPS Ground
       criteria    <<EOF
   [perl]
       return 'weight' if $Values->{country} eq 'US';
       return 'weight' if ! $Values->{country};
       # Return blank, don't want UPS
       return '';
   [/perl]
   EOF

The definable fields are, in order, for the tab-separated format:

=over 4

=item MODE

The unique identifier for that shipping method. It may be repeated as
many times as needed.

=item DESCRIPTION

Text to describe the method (can be accessed on a page with the
C<[shipping-description]> element).

=item CRITERIA

Whether shipping is based on weight, quantity, price, etc. Valid
Interchange tags can be placed in the field to do a dynamic lookup. If
a number is returned, that is used as the accumulated criteria. That
is, the total of weight, quantity, or price as applied to all items in
the shopping cart.

See C<Criteria Determination> below.

=item MINIMUM

The low bound of quantity/weight/criteria this entry applies to.

=item MAXIMUM

The high bound of quantity/weight/criteria this entry applies to. The
first found entry is used in case of ties.

=item COST

The method of developing cost. It can be a number which will be used
directly as the shipping cost, or a function, determined by a single
character at the beginning of the field:

   f       Formula (MML tags OK, evaluated as   x       Multiplied by a number
   [uA-Z]  UPS-style lookup
   m       Interchange chained cost lookup (all items summed together)
   i       Interchange chained cost lookup (items summed individually)

Perl)

=item NEXT

The C<next> field supplies an alternative shipping mode to substitute
if the cost of the current one is zero.

=item ZONE

The UPS zone that is being defined.

=item QUERY

Interchange tags which will return a SQL query to select lines
matching this specification. The current mode is replaced with this
selection. If there is a query parameter of ?, it will be replaced
with the mode name.

=item QUAL

The geographic qualification (if any) for this mode.

=item PERL

Perl code that is read and determines the criterion, not the cost. Use
the C<cost> option with "f" as the prelim to supply Perl code to
determine cost.

=item TOTAL

Set to the accumulated criterion before passing to Perl.

=item OPT

Used to maintain UPS and freeform options. Normally these are set by
separate lines in the shipping definition.

=back

=head2 Criteria Determination

The criteria field varies according to whether it is the first field
in the shipping file exactly matching the mode identifier. In that
case, it is called the main criterion. If it is in subsidiary shipping
lines matching the mode (with optional appended digits), it is called
a qualifying criterion. The difference is that the main criterion
returns the basis for the calculation (i.e., weight or quantity),
while the qualifying criterion determines whether the individual line
may match the conditions.

The return must be one of:

=over 4

=item quantity

The literal value quantity as the main criterion will simply count the
number of items in the shopping cart and return it as the accumulated
criteria. If using a database table field named C<quantity>, use the
C<table::field> notation.

=item o <field name> or <table>::<field name>

A valid database field (column) name as main criterion will cause the
number of items in the shopping cart to be multiplied by the value of
the field for each item to obtain the accumulated criteria. If the
table is not supplied, defaults to the first C<ProductFiles> table.

=item o n.nn

Where B<n.nn> is any number, it will be directly used as the
accumulated criteria. This can be effectively returned from a Perl
subroutine or Interchange C<[calc][item-list] ... [/item-list][/calc]>
to create custom shipping routines.

=back

B<IMPORTANT NOTE: >The above only applies to the first field that
matches the shipping mode exactly. Following criteria fields contain
qualifier matching strings.

=head2 Shipping Calculation Modes

There are eight ways that shipping cost may be calculated. The method
used depends on the first character of the C<cost> field in the
shipping database.

=over 4

=item N.NN (digits)

If the first character is a digit, a number is assumed and read
directly as the shipping cost.

=item e

If the first character is an C<e>, a cost of zero is returned and an
error message is placed in the session value C<ship_message> (i.e.,
C<[data session ship_message]> or $Session->{ship_message}).

=item f

If the character C<f> is the first, Interchange will first interpret
the text for any Interchange tags and then interpret the result as a
formula. It is read as Perl code; the entire set of Interchange
objects may be referenced with the code.

=item i

Specifies a chained shipping lookup which will be applied to each item
in the shopping cart.

=item m

Specifies a chained shipping lookup which will be applied to the
entire shopping cart.

=item u

Calls the UPS-style lookup. Can pre-define as many as desired. Though
if want to do the hundreds available, it is best done on-the-fly.

=item x

If an C<x> is first, a number is expected and is applied as a fixed
multiplier for the accumulated criterion (@@TOTAL@@).

=item A-Z

If the first character is a capital letter, calls one of the 26
secondary UPS-style lookup zones. (Deprecated now that zones can be
named directly).

=back

=head2 How Shipping is Calculated

=over 4

=item 1.

The base code is selected by reading the value of C<mv_shipmode> in
the user session. If it has not been explicitly set, either by means
of the DefaultShipping directive or by setting the variable on a form
(or in an order profile), it will be C<default>.

The mv_shipmode must be in the character class [A-Za-z0-9_]. If there
are spaces, commas, or nulls in the value, they will be read as
multiple shipping modes.

=item 2.

The modes are selected from the d

=over 8

=item

The criterion field is found. If it is quantity, it is the total
quantity of items on the order form. If it is any other name, the
criterion is calculated by multiplying the return value from the
product database field for each item in the shopping cart, multiplied
by its quantity. If the lookup fails due to the column or row not
existing, a zero cost will be returned and an error is sent to the
catalog error log. If a number is returned from an Interchange tag,
that number is used directly.

Entries in the shipping database that begin with the same string as
the shipping mode are examined. If none is found, a zero cost is
returned and an error is sent to the catalog error log.

=back

=back

B<Note: >The same mode name may be used for all lines in the same
group, but the first one will contain the main criteria.

=over 4

=item 3.

The value of the accumulated criteria is examined. If it falls within
the minimum and maximum, the cost is applied.

=item 4.

If the cost is fixed, it is simply added.

=item 5.

If the cost field begins with an C<x>, the cost is multiplied by the
accumulated criterion, i.e., price, weight, etc.

=item 6.

If the cost field begins with C<f>, the formula following is applied.
Use @@TOTAL@@ as the value of the accumulated criterion.

=item 7.

If the cost field begins with C<u> or a single letter from A-Z, a
UPS-style lookup is done.

=item 8.

If the cost field begins with C<s>, a Perl subroutine call is made.

=item 9.

If the cost field begins with C<e>, zero cost is returned and an error
placed in the session B<ship_message> field, available as C<[data
session ship_message]>.

=back

Here is an example shipping file using all of the methods of
determining shipping cost.

B<Note: >The columns are lined up for reading convenience. The actual
entries should have ONE tab between fields.

global Option   n/a               0   0      g PriceDivide

rpsg   RPS      quantity          0   0      R RPS products/rps.csv
rpsg   RPS      quantity          0   5      7.00 rpsg   RPS     
quantity          6   10     10.00 rpsg   RPS      quantity         
11  150    x .95

usps   US Post  price             0   0      0 usps   US Post  price  
          0   50     f 7 + (1 * @@TOTAL@@ / 10) usps   US Post  price 
           50  100    f 12 + (.90 * @@TOTAL@@ / 10) usps   US Post 
price             100 99999  f @@TOTAL@@ * .05

upsg   UPS      weight [value       0      e Nothing to ship state]0.
upsg   UPS      AK HI             0   150    u upsg [default zip 980]
12.00 round upsg   UPS                        0   150    u Ground
[default zip 980] 2.00 round upsg   UPS                        150
9999   e @@TOTAL@@ lb too heavy for UPS

upsca  UPS/CA   weight            0   0      c C UPS_Canada
products/can.csv upsca  UPS/CA   weight            -1   -1    o
PriceDivide=0 upsca  UPS/CA   weight            0   150    C upsca
[default zip A7G] 5.00 upsca  UPS/CA   weight            150 99999  e
@@TOTAL@@ lb too heavy for UPS

fedex  FedEx    quantity          1   9999   s fedex_cost ;[value
country]

=over 4

=item global

This is a global option setting, called out by the C<g> at the
beginning. PriceDivide tells the shipping routines to multiply all
shipping settings by the PriceDivide factor, except those explicitly
set differently with the C<o> individual modifier. This allows
currency conversion. (Currently the only option is PriceDivide.)

=item rpsg

If the user selected RPS, (code rpsg) and the quantity on the order
was 3, the cost of 7.00 from the second rpsg line would be applied. If
the quantity were 7, the next entry from the third rpsg line would be
selected for a cost of 10.00. If the quantity were 15, the last rpsg
would be selected and the quantity of 15 multiplied by 0.95, for a
total cost of 14.25.

=item usps

The next mode, C<usps>, is a more complicated formula using price as
the criteria. If the total price of all items in the shopping cart
(same as C<[subtotal]> without quantity price breaks in place) is from
1 to 50, the cost will be 7.00 plus 10 percent of the order. If the
total is from 50.01 to 100, the cost will be 12.00 plus 9 percent of
the order total. If the cost is 100.01 or greater, 5 percent of the
order total will be used as the shipping cost.

=item upsg

The next, C<upsg>, is a special case. It specifies a UPS lookup based
on the store's UPS zone and two required values (and two optional
arguments):

    1.     2. The zip/postal code of the recipient of which only
       the first three digits are used.
    3. A fixed amount to add to the cost found in the UPS
       tables (use 0 as a placeholder if specifying roundup)
    4. If set to 'round,' will round the cost up to the next
       integer monetary unit.

eight

If the cost returned is zero, the reason will be placed as an error
message in the session variable ship_message (available as C<[data
session ship_message]>).

UPS weights are always rounded up if any fraction is present.

The routines use standard UPS lookup tables. First, the UPS Zone file
must be present. That is a standard UPS document specific to the
retailer's area that must be obtained from UPS. It is entered into and
made available to Interchange in TAB-delimited format. (As of March
1997, use the standard .csv file distributed by UPS on their Web site
at C<www.ups.com>.) Specify it with the UpsZoneFile directive. It is
usually named something like C<NNN.csv>, where NNN is the first three
digits of the originating zip code. If placed in the products
directory, the directive would look like:

    UPSZoneFile  products/450.csv

Second, obtain the cost tables from UPS (again, get them from
C<www.ups.com>) and place them into an Interchange database. That
database, its identifier specified with the first argument (Ground in
the example) of the cost specification, is consulted to determine the
UPS cost for that weight and rate schedule.

In the example below, use a database specification like:

    Database  Ground  Ground.csv  CSV

A simple shipping cost qualification can be appended to a UPS lookup.
If any additional parameters are present after the five usual ones
used for UPS lookup, they will be interpreted as a Perl subroutine
call. The syntax is the same as if it was encased in the tag C<[perl
sub] [/perl]>, but the following substitutions are made prior to the
call:

    @@COST@@  is replaced with whatever the UPS lookup re    @@GEO@@   is replaced with the zip (or other geo code)
    @@ADDER@@ is replaced with the defined adder
    @@TYPE@@  is replaced with the UPS shipping type
    @@TOTAL@@ is replaced with the total weight

urned

The example above also illustrates geographic qualification. If the
value of the form variable state on the checkout form is AK or HI, the
U.S. states Alaska and Hawaii, a $10.00 additional charge (over and
above the normal $2.00 handling charge) is made.  This can also be
used to select on country, product type, or any other qualification
that can be encoded in the file.

=item upsca

The next entry is just like the UPS definition except it defines a
different lookup zone file (C<products/can.csv>) and uses a different
database, C<upsca>. It also disables the global PriceDivide option for
itself only, not allowing currency conversion. Otherwise, the process
is the same.

Up to 27 different lookup zones can be defined in the same fashion. If
one of the cost lines (the last field) in the C<shipping.asc> file
begins with a C<c>, it configures another lookup zone which must be
lettered from C<A to Z>.  It takes the format:

    c X name file* length* multiplier*

where X is the letter from C<A-Z>. The name is used internally as an
identifier and must be present. The optional C<file> is relative to
the catalog root (like C<UpsZoneFile> is). If it is not present, the
file equal to C<name> in the products directory (ProductDir) will be
used as the zone file. If the optional digit C<length> is present,
that determines the number of significant digits in the passed
postal/geo code.

When the optional C<multiplier> is present, the weight is multiplied
by it before doing the table lookup. This allows shipping weights in
pounds or kilograms to be adapted to a table using the opposite as the
key. Remember, the match on weight must be exact, and Interchange
rounds the weight up to the next even unit.

To define the exact equivalent of the UPS lookup zone, do the
following:

    c U UPS products/450.csv 3 1

The only difference is that the beginning code to call the lookup is
upper-case C<U> instead of lower-case C<u>.

=item fedex

The last entry, C<fedex>, uses a named subroutine. The example is
designed to work with this subroutine defined in C<catalog.cfg>:

    Sub    sub fedex_cost {
        my($country) = @_;
        my $cost;
        if($country =~ /^usa?$/i) {
            $cost = 20;
        }
        else {
            $cost = 50;
        }
        return $cost;
    }
    EOF

<<EOF

=back

B<Note: >The text above appears indented, but in the C<catalog.cfg>
file it must begin at the beginning of the line. Also, make sure to
upload in ASCII mode. Carriage returns are not tolerated.

=over 4

=item

It will simply return a cost of 20 if the country the user has entered
is US or USA. Otherwise, it will return a cost of 50. Obviously, much
more complicated routines can be defined. Read the following only if
familiar with Perl.

Named subroutines can be called with any of the methods defined with
C<[set name] your_perl_code_here [/set]>, Sub, or GlobalSub.

If parameters are specified, separated by commas, they will be taken
as either fixed values or as database fields to be sent to the
subroutine in an anonymous hash keyed on the item code (for each item
in the *current* shopping cart).

If a database other than the products database is to be used, the
database name should be prepended with a colon (C<:>) separator. If a
key other than the item code is to be used, it should be appended with
a semi-colon separator.

To send fixed value to the subroutine (appended to the call reference
as an array of fixed scalar parameters), begin the parameter with a
semicolon. They will be appended globally after the hash reference.

\Examples:

  # Sends the weight of each item from the products da
  weight

  # Sends the value of the handling field from the
  # special database for each item

  special:handling

  # Sends the value of the 'adder' field from the special
  # database, for the value the user has entered for 'country'
  # The spaces around the separators are OK

  special : adder ; [value country]

  # Sends a fixed parameter of 20 to the subroutine

  ;20

abase

The parameters are interpreted for Interchange tags before being
parsed. Here is a complete example:

   s item_cost weight,modes:[value mv_shipmode];[value country], ;2
  items in the shopping cart:  00-0011 19=202

  ------- product database  ----

  code    weight   description      price
  00-0011   8      The Mona Lisa    1000
  19-202    12     American Gothic  800

    ------- modes database  ----

  code    upsg  upsb  upsr  postal_air postal_surface
  UK        0    0     0       1            1

, ;25

This will call the subroutine C<item_cost> and will send the weight of
each item, along with the value of the modes database column
corresponding to the shipping mode the user has selected, keyed with
the value of C<country> on their order form. If the user has selected
C<mode postal_air> and is in the country coded as C<UK>, the
subroutine will be called as if it was:

      item_c                    '00-0011' => {postal_air => '1', weight => '8'},
                    '19-202' => {postal_air => '1', weight => '12'},
                 }, 20, 25 )

st( {

If the undefined value is returned by the routine, the next shipping
mode will be tried. If a non-numeric string value is returned, its
value will be placed as an error message in the session variable
ship_message (available as C<[data session ship_message]>) and a zero
cost will be returned. If any number or the empty string is returned,
it will be used as the shipping cost (even 0).

=back

=head2 More On UPS-Style Lookup

The UPS-style lookup uses two files for its purposes, both of which
need to be in a format like UPS distributes for US shippers.

The zone file is a file that is usually specific to the originating
location. For US shippers shipping to US locations, it is named for
the first three digits of the originating zip code with a CSV
extension. For example, C<450.csv>.

It has a format similar to:

   low - high, zone,zone,zone,zone

The C<low> entry is the low bound of the geographic location; C<high>
is the high bound. (By geographic location, the zip code is meant.) If
the first digits of the zip code, compared alphanumerically, fall
between the low and high values, that zone is used as the column name
for a lookup in the rate database. The weight is used as the row key.

The first operative row of the zone file (one without leading quotes)
is used to determine the zone column name. In the US, it looks
something like:

Dest. ZIP,Ground,3 Day Select,2nd Day Air,2nd Day Air A.M.,Next Day
Air Saver,Next Day Air

Interchange strips all non-alpha characters and comes up with:

DestZIP,Ground,3DaySelect,2ndDayAir,2ndDayAirAM,NextDayAirSaver,NextDayAir

Therefore, the zone column (shipping type) that would be used for UPS
ground would be "Ground," and that is what the database should be
named. To support the above, use a C<shipping.asc> line that reads:

   upsg  UPS Ground  weight  0  150  u Ground [default zip 983]

and a C<catalog.cfg> database callout of:

   Database  Ground  Ground.csv  CSV

These column names can be changed as long as they correspond to the
C<identifier> of the rate database.

The rate database is a standard Interchange database. For U.S.
shippers, UPS distributes their rates in a fairly standard
comma-separated value format, with weight being the first (or key)
column and the remainder of the columns corresponding to the zone
which was obtained from the lookup in the zone file.

To adapt other shipper zone files to Interchange's lookup, they will
need to fit the UPS US format. (Most of the UPS international files
don't follow the U.S. format). For example, the 1998 Ohio-US to Canada
file begins:

   Canada Standard Zone Charts from Ohio
   Locate the zone by cross-referencing the first three
   characters of the destination Postal Code in the Postal
   Range column.

   Postal Range  Zone
   A0A  A9Z      54
   B0A  B9Z      54
   C0A  C9Z      54
   E0A  E9Z      54
   G0A  G0A      51
   G0B  G0L      54
   G0M  G0S      51
   G0T  G0W      54

It will need to be changed to:

   Destination,canstnd
   A0A-A9Z, 54
   B0A-B9Z, 54
   C0A-C9Z, 54
   E0A-E9Z, 54
   G0A-G0A, 51
   G0B-G0L, 54
   G0M-G0S, 51
   G0T-G0W, 54

Match it with a C<canstnd> CSV database that looks like this:

   Weight,51,52,53,54,55,56
   1,7.00,7.05,7.10,11.40,11.45,11.50
   2,7.55,7.65,7.75,11.95,12.05,12.10
   3,8.10,8.15,8.40,12.60,12.70,12.85
   4,8.65,8.70,9.00,13.20,13.30,13.55
   5,9.20,9.25,9.75,13.85,13.85,14.20
   6,9.70,9.85,10.35,14.45,14.50,14.90
   7,10.25,10.40,11.10,15.15,15.15,15.70
   8,10.80,10.95,11.70,15.70,15.75,16.35
   9,11.35,11.55,12.30,16.40,16.45,17.20

It is called out in catalog.cfg with:

   Database canstnd canstnd.csv CSV

With the above, a 4-pound shipment to postal code E5C 4TL would yield
a cost of 13.20.

=head2 Geographic Qualification

If the return value in the main criterion includes whitespace, the
remaining information in the field is used as a qualifier for the
subsidiary shipping modes. This can be used to create geographic
qualifications for shipping, as in:

 upsg   UPS Ground   weight [value state]   0     0     e No items selected
upsg   UPS Ground   AK HI                  0     150   u Ground [value zip] 12.00
upsg   UPS Ground                          0     150   u Ground [value zip] 3.00

If C<upsg> is the mode selected, the value of the user session
variable C<state> is examined to see if it matches the geographic
qualification on a whole-word boundary. If it is C<AK> or C<HI>, UPS
Ground with an adder of 12 will be selected. If it "falls through,"
UPS Ground with an adder of 3 will be selected.

=head2 Handling Charges

Additional handling charges can be defined in the shipping file by
setting the form variable C<mv_handling> to a space, comma, or
null-separated set of valid shipping modes. The lookup and charges are
created in the same fashion, and the additional charges are added to
the order. (The user is responsible for displaying the charge on the
order report or receipt with a C<[shipping handling]> tag, or the
like.) All of the shipping modes found in mv_handling will be applied.
If multiple instances are found on a form, the accordingly
null-separated values will all be applied. NOTE: This should not be
done in an item-list unless the multiple setting of the variables is
accounted for.

To only process a handling charge once, do the following:

   [item-list]
   [if-item-field very_heavy]
   [perl values]
       return '' if $Values->{mv_handling} =~ /very_heavy/;
       return "<INPUT TYPE=hidden NAME=mv_handling VALUE=very_heavy>";
   [/perl]
   [/if-item-field]
   [/item-list]

A non-blank/non-zero value in the database field will trigger Perl
code which will only set C<mv_handling> once.

=head2 Default Shipping Mode

If a default shipping mode other than C<default> is desired, enter it
into the C<DefaultShipping> directive:

   DefaultShipping     upsg

This will make the entry on the order form checked by default when the
user starts the order process, if it is put in the form:

 <INPUT TYPE=RADIO NAME=mv_shipmode VALUE=upsg [checked mv_shipmode upsg]>

To force a choice by the user, make C<mv_shipmode> a required form
variable (with RequiredFields or in an order profile) and set
C<DefaultShipping> to zero.

=head1 USER DATABASE

Interchange has a user database function which allows customers to
save any pertinent values from their session. It also allows the
setting of database or file access control lists for use in
controlling access to pages and databases on a user-by-user basis.

The database field names in the user database correspond with the form
variable names in the user session. If there is a column named
C<address>, when the user logs in the contents of that field will be
placed in the form variable C<address>, and will be availabe for
display with C<[value address]>. Similarly, the database value is
available with C<[data table=userdb column=address key=username]>.

The ASCII file for the database will not reflect changes unless the
file is exported with C<[tag export userdb][/tag]>. It is not
advisable to edit the ASCII file, as it will overwrite the real data
that is in the DBM table. User logins and changes would be lost. NOTE:
This would not happen with SQL, but editing the ASCII file would have
no effect. It is recommended that the NoImport configuration directive
be set accordingly.

The field names to be used are not set in concrete. They may be
changed with options. Fields may be added or subtracted at any time.
Most users will choose to keep the default demo fields for simplicity
sake, as they cover most common needs. As distributed in the demo, the
fields are:

   code
   accounts
   acl
   address
   address_book
   b_address
   b_city
   b_country
   b_name
   b_nickname
   b_phone
   b_state
   b_zip
   carts
   city
   country
   db_acl
   email
   email_copy
   fax
   fax_order
   file_acl
   mv_credit_card_exp_month
   mv_credit_card_exp_year
   mv_credit_card_info
   mv_credit_card_type
   mv_shipmode
   name
   order_numbers
   p_nickname
   password
   phone_day
   phone_night
   preferences
   s_nickname
   state
   time
   zip

A few of those fields are special in naming, though all can be changed
via an option. A couple of the fields are reserved for Interchange's
use.

B<IMPORTANT NOTE: >If not running with PGP or other encryption for
credit card numbers, which is never recommended, it is important that
the mv_credit_card_info field be removed from the database.

The special database fields are:

   accounts         Storage for billing accounts book
   address_book     Storage for shipping address book
   b_nickname       Nickname of current billing account
   carts            Storage for shopping carts
   p_nickname       Nickname for current preferences
   preferences      Storage for preferences
   s_nickname       Nickname for current shipping address
   db_acl           Storage for database access control lists
   file_acl         Storage for file access control lists
   acl              Storage for simple integrated access control

If not defined, the corresponding capability is not available.

B<Note: >The fields C<accounts>, C<address_book>, C<carts>, and
C<preferences> should be defined as a BLOB type, if using SQL. This is
also suggested for the acl fields if those lists could be large.

Reserved fields include:

   code        The username (key for the database)
   password    Password storage
   time        Last time of login

=head2 The [userdb ...] Tag

Interchange provides a C<[userdb ...]> tag to access the UserDB
functions.

 [userdb
       function=function_name
       username="username"*
       assign_username=1
       username_mask=REGEX*
       password="password"*
       verify="password"*
       oldpass="old password"*
       crypt="1|0"*
       shipping="fields for shipping save"
       billing="fields for billing save"
       preferences="fields for preferences save"
       ignore_case="1|0"*
       force_lower=1
       param1=value*
       param2=value*
       ...
       ]

* Optional

It is normally called in an C<mv_click> or C<mv_check> setting, as in:

   [set Login]
   mv_todo=return
   mv_nextpage=welcome
   [userdb function=login]
   [/set]

   <FORM ACTION="[process-target]" METHOD=POST>
   <INPUT TYPE=hidden NAME=mv_click VALUE=Login>
   Username <INPUT NAME=mv_username SIZE=10>
   Password <INPUT NAME=mv_password SIZE=10>
   </FORM>

There are several global parameters that apply to any use of the
C<userdb> functions. Most importantly, by default, the database table
is set to be userdb. If another table name must be used, include a
C<database=table> parameter with any call to C<userdb>. The global
parameters (default in parens):

   database     Sets user database table (userdb)
   show         Show the return value of certain functions
                or the error message, if any (0)
   force_lower  Force possibly upper-case database fields
                to lower case session variable names (0)
   billing      Set the billing fields (see Accounts)
   shipping     Set the shipping fields (see Address Book)
   preferences  Set the preferences fields (see Preferences)
   bill_field   Set field name for accounts (accounts)
   addr_field   Set field name for address book (address_book)
   pref_field   Set field name for preferences (preferences)
   cart_field   Set field name for cart storage (carts)
   pass_field   Set field name for password (password)
   time_field   Set field for storing last login time (time)
   expire_field Set field for expiration date (expire_date)
   acl          Set field for simple access control storage (acl)
   file_acl     Set field for file access control storage (file_acl)
   db_acl       Set field for database access control storage (db_acl)

By default the system crypt() call will be used to compare the
password. This is best for security, but the passwords in the user
database will not be human readable.

If no critical information is kept and Interchange administration is
not done via the C<UserDB> capability, use the C<UserDB> directive
(described below) to set encryption off by default:

   UserDB   default   crypt   0

Encryption can still be set on by passing C<crypt=1> with any call to
a C<new_account>, C<change_pass>, or C<login> call.

=head2 Setting Defaults with the UserDB Directive

The C<UserDB> directive provides a way to set defaults for the user
database. For example, to save and recall the scratch variable
C<tickets> in the user database instead of the form variable
C<tickets>, set:

   UserDB   default   scratch  tickets

That makes every call to C<[userdb function=login]> equivalent to
C<[userdb function=login scratch=tickets]>.

To override that default for one call only, use C<[userdb
function=login scratch="passes"]>.

To log failed access authorizations, set the C<UserDB> profile
parameter C<log_failed> true:

   UserDB  default  log_failed 1

To disable logging of failed access authorizations (the default), set
the C<UserDB> profile parameter C<log_failed> to 0:

   UserDB  default  log_failed 0

The C<UserDB> directive uses the same key-value pair settings as the
C<Locale> and C<Route> directives. If there are more than one set of
defaults, set them in a hash structure:

   UserDB  crypt_case  <<EOF
   {
       'scratch'        => 'tickets',
       'crypt'          => '1',
       'ignore_case'    => '0',
   }
   EOF

   UserDB  default  <<EOF
   {
       'scratch'        => 'tickets',
       'crypt'          => '1',
       'ignore_case'    => '1',
   }
   EOF

B<Note: >The usual here-document caveats apply. The "EOF" must be on a
line by itself with no leading/trailing whitespace.

The last one to be set becomes the default.

The option C<profile> selects the set to use. For usernames and
passwords to be case sensitive with no encryption, pass this call:

   [userdb function=new_account profile=case_crypt]

The username and password will be stored as typed in, and the password
will be encrypted in the database.

=head2 User Database Functions

The user database features are implemented as a series of functions
attached to the C<userdb> tag. The functions are:

=over 4

=item login

Active parameters: username, password, crypt, pass_field, ignore_case

Log in to Interchange. By default, the username is contained in the
form variable C<mv_username> and the password in C<mv_password>. If
the login is successful, the session value C<username> (C<[data
session username]>) will be set to the user name.

This will recall the values of all non-special fields in the user
database and place them in their corresponding user form variables.

The C<CookieLogin> directive (catalog.cfg) allows users to save their
username/password in a cookie. Expiration time is set by
C<SaveExpire>, renewed every time they log in. To cause the cookie to
be generated originally, the form variable C<mv_cookie_password> or
C<mv_cookie_username> must be set in the login form. The former causes
both username and password to be saved, the latter just the username.

=item logout

Log out of Interchange. No additional parameters are needed.

=item new_account

Active parameters: username, password, verify, assign_username,
username_mask, ignore_case

Create a new account. It requires the C<username>, C<password>, and
C<verify> parameters, which are by default contained in the form
variables C<mv_username>, C<mv_password>, C<mv_verify> respectively.

If the C<assign_username> parameter is set, C<UserDB> will assign a
sequential username. The C<counter> parameter can be used to set the
filename (must be absolute), or the default of
CATALOG_DIR/etc/username.counter can be accepted. The first username
will be "U0001" if the counter doesn't exist already.

The C<ignore_case> parameter forces the username and password to lower
case in the database, in effect rendering the username and password
case-insensitive.

If C<username_mask> is set to a valid Perl regular expression (without
the surrounding / /), then any username containing a matching string
will not be allowed for use. For example, to screen out order numbers
from being used by a random user:

    [userdb function=new_a            username_mask="^[A-Z]*[0-9]"
            ]

count

The C<CookieLogin> directive (catalog.cfg) allows users to save their
username/password in a cookie. Expiration time is set by
C<SaveExpire>, renewed every time they log in. To cause the cookie to
be generated originally, the form variable C<mv_cookie_password> or
C<mv_cookie_username> must be set in the login form. The former causes
both username and password to be saved, the latter just the username.

To automatically create an account for every order, set the following
in the C<OrderReport> file:

    [userdb function=new_a            username="[value mv_order_number]"
            password="[value zip]"
            verify="[value zip]"
            database="orders"
            ]

count

This would be coupled with a login form that asks for order number and
zip code, thereupon allowing the display of the contents of a
transaction database with (presumably updated) order status
information or a shipping company tracking number.

=item change_pass

Active parameters: username, password, verify, oldpass

Change the password on the currently logged-in account. It requires
the C<username>, C<password>, C<verify>, and C<oldpass> parameters,
which are by default contained in the form variables C<mv_username>,
C<mv_password>, C<mv_verify>, C<mv_password_old> respectively.

=item set_shipping

Active parameters: nickname, shipping, ship_field

Place an entry in the shipping Address book. For example:

    [userdb function=set_shipping nickname=Dad]

See Address Book below.

=item get_shipping

Active parameters: nickname, shipping, ship_field

Recall an entry from the shipping Address book. For example:

    [userdb function=get_shipping nickname=Dad]

See Address Book below.

=item get_shipping_names

Active parameters: ship_field

Gets the names of shipping address book entries and places them in the
variable C<address_book>. By default, it does not return the values.
To have the values returned, set the parameter C<show> to 1, as in:

    [set name=shipping_nic         interpolate=1]
      [userdb function=get_shipping_names show=1]
    [/set]

names

=item set_billing

Active parameters: nickname, billing, bill_field

Place an entry in the billing accounts book. For example:

    [userdb function=set_billing nickname=discover]

See Accounts Book below.

=item get_billing

Active parameters: nickname, billing, bill_field

Recall an entry from the billing accounts book. For example:

    [userdb function=get_billing nickname=visa]

See Accounts Book below.

=item save

Saves all non-special form values that have columns in the user
database.

=item set_cart

Save the contents of a shopping cart.

    [userdb function=set_cart nickname=christmas]

See Carts below.

=item get_cart

Active parameters: nickname, carts_field, target

Recall a saved shopping cart.

    [userdb function=get_cart nickname=mom_birthday]

Setting C<target> saves to a different shopping cart than the default
main cart. The C<carts_field> controls the database field used for
storage.

=item set_acl

Active parameters: location, acl_field, delete

Set a simple acl. For example:

    [userdb function=set_acl location=cartcfg/editcart]

This allows the current user to access the page "cartcfg/editcart" if
it is access-protected.

To delete access, do:

    [userdb function=set_acl location=cartcfg/editcart delete=1]

To display the setting at the same time as setting, use the C<show>
attribute:

    [userdb function=set_acl location=cartcf/editcart show=1]

=item check_acl

Active parameters: location, acl_field

Checks the simple access control listing for a location, returning 1
if allowed and the empty string if not allowed.

    [if type=ex        compare="[userdb
                    function=check_acl
                    location=cartcfg/editcart]"
    ]
    [page cartcfg/editcart]Edit your cart configuration[/page]
    [/if]

licit

=item set_file_acl, set_db_acl

Active parameters: location, mode, db_acl_field, file_acl_field,
delete

Sets a complex access control value. Takes the form:

    [userdb function=set_fi            mode=rw
            location=products/inventory.txt]

e_acl

where mode is any value to be checked with C<check_file_acl>. As with
the simple ACL, use delete=1 to delete the location entirely.

=item check_file_acl, check_db_acl

Active parameters: location, mode, db_acl_field, file_acl_field

Checks a complex access control value and returns a true/false (1/0)
value. Takes the form:

    [userdb function=check_            mode=w
            location=inventory]

b_acl

where mode is any value to be checked with C<check_file_acl>. It will
return true, if the mode string is contained within the entry for that
location. For example:

    [if type=ex        compare="[userdb
                    function=check_db_acl
                    mode=w
                    location=inventory]"
    ]
    [userdb function=set_acl location=cartcfg/edit_inventory]
    [page cartcfg/edit_inventory]You may edit the inventory database[/page]
    [else]
    [userdb function=set_acl location=cartcfg/edit_inventory delete=1]
    Sorry, you can't edit inventory.
    [/if]

licit

=back

=head2 Address Book

Address_book is a shipping address book. The shipping address book
saves information relevant to shipping the order. In its simplest
form, this can be the only address book needed. By default these form
values are included:

  s_nickname
  name
  fname
  lname
  address
  address1
  address2
  address3
  city
  state
  zip
  country
  phone_day
  mv_shipmode

The first field is always the name of the form variable that contains
the key for the entry. The values are saved with the C<[userdb
function=set_shipping]> tag call, and are recalled with C<[userdb
function=get_shipping]>. A list of the keys available is kept in the
form value C<address_book>, suitable for iteration in an HTML select
box or in a set of links.

To get the names of the addresses, use the C<get_shipping_names>
function:

   [userdb function=get_shipping_names]

By default, they are placed in the variable C<address_book>. Here is a
little snippet that builds a select box:

   <FORM ACTION="[process-target]" METHOD=POST>
   [userdb function=get_shipping_names]
   [if value address_book]
   <SELECT NAME="s_nickname">
   [loop arg="[value address_book]"] <OPTION> [loop-code] [/loop]
   </SELECT>
   <INPUT TYPE=submit NAME=mv_check VALUE="Recall Shipping">
   </FORM>

The same principle works with accounts, carts, and preferences.

To restore a cart based on the above, put in an C<mv_check> routine:

   [set Recall Shipping]
   mv_todo=return
   mv_nextpage=ord/basket
   [userdb function=get_shipping nickname="[value s_nickname]"]
   [/set]

When the C<mv_check> variable is encountered, the contents of the
scratch variable C<Recall Shipping> are processed and the shipping
address information inserted into the user form values. This is
destructive of any current values of those user session variables, of
course.

To change the fields that are recalled or saved, use the C<shipping>
parameter:

   [userdb function=get_shipping
           nickname=city_and_state
           shipping="city state"]

Only the values of the C<city> and C<state> variables will be
replaced.

=head2 Accounts Book

The accounts book saves information relevant to billing the order. By
default these form values are included:

  b_nickname
  b_name
  b_fname
  b_lname
  b_address
  b_address1
  b_address2
  b_address3
  b_city
  b_state
  b_zip
  b_country
  b_phone
  purchase_order
  mv_credit_card_type
  mv_credit_card_exp_month
  mv_credit_card_exp_year
  mv_credit_card_info

The values are saved with the C<[userdb function=set_billing]> tag
call, and are recalled with C<[userdb function=get_billing]>. A list
of the keys available is kept in the form value C<accounts>, suitable
for iteration in an HTML select box or in a set of links.

=head2 Preferences

Preferences are miscellaneous session information. They include, by
default, the following fields:

   email
   fax
   phone_night
   fax_order
   email_copy

The field C<p_nickname> acts as a key to select the preference set. To
change the values that are included with the C<preferences> parameter:

   [userdb function=set_preferences
           preferences="email_copy email fax_order fax"]

or in catalog.cfg:

   UserDB default preferences "mail_list email fax_order music_genre"

=head2 Carts

The contents of shopping carts may be saved or recalled in much the
same fashion. See the Simple demo application C<ord/basket.html> page
for an example.

=head2 Controlling Page Access With UserDB

Interchange can implement a simple access control scheme with the user
database. Controlled pages must reside in a directory which has a file
named C<.access> that is zero bytes in length. (If it is more than 0
bytes, only the RemoteUser or MasterHost may access files in that
directory.)

Set the following variables in C<catalog.cfg>:

   Variable   MV_USERDB_ACL_TABLE  userdb
   Variable   MV_USERDB_ACL_COLUMN acl

The C<MV_USERDB_ACL_TABLE> is the table which controls access, and
likewise the C<MV_USERDB_ACL_TABLE> names the column in that database
which will be checked for authorization.

The database entry should contain the complete Interchange-style page
name of the page to be allowed. It will not match substrings.

For example, if the user C<flycat> followed this link:

   <A HREF="[area cartcfg/master_edit]">Edit</A>

Access would be allowed if the contents of the userdb were:

   code    acl
   flycat  cartcfg/master_edit

and disallowed if it were:

   code    acl
   flycat  cartcfg/master_editor

Access can be enabled with:

   [userdb function=set_acl location="cartcfg/master_edit"]

Access can be disallowed with:

   [userdb function=set_acl
           delete=1
           location="cartcfg/master_edit"]

Of course, a pre-existing database with the ACL values will work as
well. It need not be in the UserDB setup.

=head1 FREQUENTLY ASKED QUESTIONS

=head2 Does Interchange require SQL?

No. Interchange does not require SQL. If you have a small database
with no particular desire to integrate your own tool set, you may be
more comfortable using Interchange's internal database.

Bear in mind that the order management functions of Interchange will
be slow and not as robust without SQL. SQL is strongly recommended for
at least these three tables:

       orderline
       transactions
       userdb

=head2 I can't get SQL to work: Undefined subroutine &Vend::Table::DBI::create ...

This probably means one of the following:

=over 4

=item No SQL database.

Interchange doesn't include a SQL database. You must select one and
install it.

=item No DBI.

You must install Perl's DBI module before using Interchange with SQL.
You can see where to get it at C<http://www.cpan.org>, or try:

    perl -MCPAN -e 'install DBI'

=item No DBD.

You must install the specific Perl DBD module for your database before
using Interchange with SQL. You can see where to get it at
C<http://www.cpan.org>, or try:

    perl -MCPAN -e 'install DBD::XXXXX'

where XXXX is the name of your module. Some of them are:

        DB2
    Informix
    Ingres
    ODBC
    Oracle
    Pg
    Solid
    Sybase
    Unify
    XBase
    mSQL
    mysql

dabas

If you can't make this script run without error:

    us    use DBD::XXXXX;

 DBI;

Then you don't have one of the above, and Interchange will never run a
SQL type.

=item I don't like the column types that Interchange defines!

They can be changed. See the C<simple/mysql> directory for some
examples under MySQL.

=item I change the ASCII file, but the table is not updated. Why?

Interchange writes an empty file C<TABLE.sql> (where TABLE is the name
of the table). When this is present, Interchange will never update the
table from disk.

Also, if you have changed the field names in the file, you must
restart the catalog (Apply Changes) before they will be picked up.

=item Why do I even need an ASCII file?

Interchange wants some source for column names initially. If you don't
want to have one, just create a C<TABLENAME.sql> file in the
C<products> directory. For example, if you have this:

    Database products products.txt dbi:mysql:test_minivend

Then create a file C<products/products.sql>.

\For:

    Database pricing pricing.txt dbi:mysql:test_minivend

Create a file C<products/pricing.sql>. .

=item Interchange overwrites my predefined table!

Yes, it will if you don't create a file called C<TABLENAME.sql>, where
C<TABLENAME> is the name of the Interchange table. If you want this to
happen by default, then set C<NoImport TABLENAME>.

=back

=head2 How can I use Interchange with Microsoft Access?

Though Interchange has ODBC capability, the Microsoft Access ODBC
driver is not a network driver. You cannot access it on a PC from your
ISP or UNIX system.

However, you can turn it around.  Once you have created a MySQL or
other SQL database on the UNIX machine, you may then obtain the
Windows ODBC driver for the database (mySQL has a package called
myODBC) and use the UNIX database as a data source for your PC-based
database program.

Here is a quick procedure that might get you started:

=over 4

=item *

Get mySQL from:

    http://www.mysql.com

Install it on your UNIX box. On LINUX, it is as easy as getting the
RPM distribution:

    http://www.mysql.com/rpm/

You install it by typing, as root, C<rpm -i mysql-3.XX.XX.rpm>. If you
are not root, you will have to build the source distribution.

=item *

To avoid permissions problems for your testing, stop the mysql daemon
and allow global read-write access with:

    mysqladmin sh    safe_mysqld --skip-grant-tables &

tdown

Obviously, you will want to study mySQL permissions and set up some
security pretty quickly. It has excellent capability in that area, and
the FAQ will help you get over the hurdles.

=item *

Set up a database for testing on the UNIX machine:

    mysqladmin create tes    mysql test_odbc

_odbc

Make an SQL query to set up a table, for example:

    mysql> create table test_me ( code char(20), testdata char(    Query OK, 0 rows affected (0.29 sec)

    mysql> insert into test_me VALUES ('key1', 'data1');
    Query OK, 1 rows affected (0.00 sec)

    mysql> insert into test_me VALUES ('key2', 'data2');
    Query OK, 1 rows affected (0.00 sec)

    mysql>

0) );

=item *

Get and install myODBC, also from the MySQL site (use a mirror):

    http://www.mysql.com

You install this package on your Windows 95 or NT box. It is a simple
setup.exe process which leads you to the control panel for setting up
an ODBC data source.  Set up a data source named C<test_odbc> that
points to the database C<test_odbc> on the UNIX box. You will need to
know the host name and the port (usually 3306).

=item *

With MS-Access, you can then open a blank database and select:
File/Get External Data/Link Tables. Select File Type of 'ODBC
databases' and the proper data source, and you should have access to
the database residing on the UNIX side.

=back

=head1 INTERCHANGE DATABASE USERTAGS

=head2 Data

=over 4

=item

Named Parameters: [data table=db_table column=column_name key=key
filter=``uc|lc|name|namecase|no_white|etc.''* append=1* value=``value
to set to''* increment=1* ]

Positional parameters: [data db_table column key]

The attribute hash reference is passed to the subroutine after the
parameters as the last argument. This may mean that there are
parameters not shown here.

Must pass named parameter interpolate=1 to cause interpolation.

Invalidates cache: no

Called Routine:

ASP/perl tag calls:

   $Tag-       {
        table => VALUE,
        field => VALUE,
        key => VALUE,
       }
   )

data(

OR

   $Tag->data($table, $field, $key, $ATTRHASH);

Attribute aliases:

           base ==>           code ==> key
           col ==> field
           column ==> field
           database ==> table
           name ==> field
           row ==> key

table

Returns the value of the field in a database table, or (DEPRECATED)
from the session namespace. If the optional value is supplied, the
entry will be changed to that value. If the option increment* is
present, the field will be  automatically incremented with the value
in value. Use negative numbers in value to decrement. The append
attribute causes the value to be appended. The filter attribute is a
set of Interchange filters that are applied to the data 1) after it is
read; or 2) before it is placed in the table.

If a DBM-based database is to be modified, it must be flagged writable
on the page calling the write tag. Use [tag flag write]products[/tag]
to mark the products database writable, for example. This must be done
before ANY access to that table.

DEPRECATED BEHAVIOR: (replace with session tag). In addition, the
[data ...]  tag can access a number of elements in the Interchange
session database:

    accesses           Accesses within the last 30 s    arg                The argument passed in a [page ...] or [area ...] tag
    browser            The user browser string
    cybercash_error    Error from last CyberCash operation
    cybercash_result   Hash of results from CyberCash (access with usertag)
    host               Interchange's idea of the host (modified by DomainTail)
    last_error         The last error from the error logging
    last_url           The current Interchange path_info
    logged_in          Whether the user is logged in (add-on UserDB feature)
    pageCount          Number of unique URLs generated
    prev_url           The previous path_info
    referer            HTTP_REFERER string
    ship_message       The last error messages from shipping
    source             Source of original entry to Interchange
    time               Time (seconds since Jan 1, 1970) of last access
    user               The REMOTE_USER string
    username           User name logged in as (UserDB feature)

conds

=back

B<Note: >Databases will hide session values, so don't name a database
`session''. or you won't be able to use the [data ...] tag to read
them. Case is sensitive, so in a pinch you could call the database
``Session'', but it would be better not to use that name at all.

=head2 db_date

   # [db-date table f   #
   # This tag returns the last-modified time of a database table,
   # 'products' by default. Accepts a POSIX strftime value for
   # date format; uses '%A %d %b %Y' by default.
   #
   UserTag  db-date  Order table format
   UserTag  db-date  PosNumber 2
   UserTag  db-date  Routine <<EOF
   sub {
       my ($db, $format) = @_;
       my ($dbfile, $mtime);

       # use defaults if necessary
       $db = 'products' unless $db;
       $format = '%A %d %b %Y' unless $format;

       # build database file name
       $dbfile = $Vend::Cfg->{ProductDir} . '/'
               . $Vend::Cfg->{Database}{$db}{'file'};

       # get last modified time
       $mtime = (stat ($dbfile))[9];

       if (defined ($mtime)) {
               return POSIX::strftime($format, localtime($mtime));
       } else {
               logError ("Couldn't stat $dbfile: $!\n");
       }
   }
   EOF

rmat]

=head2 Search_region

=over 4

=item

Named Parameters: [search_region arg="arg"]

Positional Parameters: [search_region arg]

The attribute hash reference is passed after the parameters but before
the container text argument. This may mean that there are parameters
not shown here.

Must pass named parameter interpolate=1 to cause interpolation.

This is a container tag, i.e. [search_region] FOO [/search_region].
Nesting: NO

Invalidates cache: no

Called Routine:

ASP/perl tag calls:

    $Tag->search_r        {
         arg => VALUE,
        },
        BODY
    )

gion(

OR

    $Tag->search_region($arg, $ATTRHASH, $BODY);

Attribute aliases:

            args =            params ==> arg
            search ==> arg

> arg


=over 8

=item *

Akopia and Interchange are registered trademarks of Akopia, Inc. All
other product names are trademarks or registered trademarks of their
respective manufacturers. This version of the document supersedes any
and all previous versions.

=back
=back

