[comment]
ui_template: Yes
ui_template_name: leftonly
[/comment]

[control reset=1]

[control-set]
[component]search_box_small[/component]
[/control-set]

[control-set]
[component]cart_tiny[/component]
[/control-set]

[control-set]
[component]category_vertical[/component]
[/control-set]

[control-set]
[component][/component]
[/control-set]

[control-set]
[component]random[/component]
[size]3[/size]
[cols]3[/cols]
[/control-set]

[control reset=1]

[set members_only]1[/set]
[set page_banner]Process Order Return[/set]
[set page_title]__COMPANY__ -- Process Order Return[/set]

@_LEFTONLY_TOP_@

<!-- BEGIN CONTENT -->

[if !value return_items]

					<p>
                    <p><font __FFACE__ size="2" color="#669999"> 
					No items were selected for return.
					<br><br>
					Please use your browser's back button to return to the order and select at least
					one item from the order to return.
					  </font></p>

[else]					  

[set ret_num_items][/set]
[set qty_over][/set]


[perl tables="orderline"]

my @items = split /\0/, $Values->{return_items};
my $num_items = @items;
$Scratch->{ret_num_items} = $num_items;

my $count = 0;
my $amount3 = 0;
my $total_qty = 0;

foreach (@items) {

my $code = @items[$count];
my $qty1 = $Tag->data('orderline', 'quantity', $code);
my $amount1 = $Tag->data('orderline', 'price', $code);
my $code = "qty-$code";
my $qty2 = $Values->{$code};
my $amount2 = $amount1 * $qty2;
$amount3 = $amount2 + $amount3;
$total_qty = $qty2 + $total_qty;

$Scratch->{return_credit} = $amount3;
$Scratch->{total_qty} = $total_qty;

	if($qty1 < $qty2) {

$Scratch->{qty_over} = 1;	

	}
	
$count ++;
}


[/perl]

[if scratch qty_over]

					<p>
                    <p><font __FFACE__ size="2" color="#669999"> 
					You may not return more items than you originally purchased.
					<br><br>
					Please use your browser's back to enter a more appropriate value.
					  </font></p>

[else]					  

[seti rma_number][counter etc/rma.number][/seti]

					<p>
                    <p><font __FFACE__ size="2" color="#669999"> 
					Your return has been processed. Please ship the item(s) to the address below and your
					account will be credited for the returned amount. A return confirmation has also been
					emailed to you.
					<br><br>
					Be sure to list the RMA number issued below on your shipping label.
					  </font></p>
                    <p><font __FFACE__ size="2" color="#999999">__COMPANY__<br>
                      11480 Sunset Hills Road<br>
                      Suite 200 East<br>
                      Reston, VA 20190<br>
						</font><font __FFACE__ size="2" color="#FF9900"><br>
                      </font></p>					  
                    <table width="300" border="1" cellspacing="0" cellpadding="0" bordercolordark="#FF9900" bordercolorlight="#FF9900">
                      <tr>
                        <td>
							<table cellpadding="4" cellspacing="4" border="0">
							<tr>
							<td><font __FFACE__ size="2"><b>RMA Number:</b></font></td>
							<td><font __FFACE__ size="2"><b>[scratch rma_number]</b></font></td>
							</tr>
							</table>
                          </td>
                      </tr>
                    </table>
					
					<p>
					
					<table width="300" border="0" cellspacing="0" cellpadding="0" bordercolordark="#FF9900" bordercolorlight="#FF9900">
                      <tr>
                        <td>
							<table cellpadding="4" cellspacing="4" border="0">
							<tr>
							<td><font __FFACE__ size="2"><b>Order Number:</b></font></td>
							<td><font __FFACE__ size="2"><b>[value order_number]</b></font></td>
							</tr>
							<tr>
							<td><font __FFACE__ size="2"><b>Number Of Items:</b></font></td>
							<td><font __FFACE__ size="2"><b>[scratch total_qty]</b></font></td>
							</tr>
							<tr>
							<td><font __FFACE__ size="2"><b>Approximate Credit:</b></font></td>
							<td><font __FFACE__ size="2"><b>[currency][scratch return_credit][/currency]</b></font></td>
							</tr>							
							</table>
                          </td>
                      </tr>
                    </table>

					
                    <p>&nbsp; </p>

[set name=return1 interpolate=1]

[comment] SEND REPORT OF NEW RETURN TO SHOP OWNER [/comment]

[email
					to="__COMPANY__ <__ORDERS_TO__>"
                    subject="__COMPANY__ - RMA: [scratch rma_number]"
                    from="[value email] <[value email]>"
                    reply="[value email] <[value email]>"]

Return request received.

      Company: [value company]
         Name: [value fname] [value lname]
        Email: [value email]
    Day Phone: [value phone_day]
Evening Phone: [value phone_night]
		
   RMA Number: [scratch rma_number]
  Date Issued: [tag time]%Y%m%d %H:%M:%S[/tag]		
		
 Order Number: [value order_number]
Item Quantity: [scratch total_qty]
Credit Amount: [currency][scratch return_credit][/currency]
					
[/email]

[/set]

[set name=return1 interpolate=1]

[comment] SEND RETURN SUMMARY TO CUSTOMER [/comment]

[email
					to="[value email]"
                    subject="__COMPANY__ - RMA: [scratch rma_number]"
                    from="__COMPANY__ <__ORDERS_TO__>"
                    reply="__COMPANY__ <__ORDERS_TO__>"]

Hello and thank you for your interest in __COMPANY__ products.

We have received your return request and have issued you an RMA number.

Please use the information below to process your return:

Shipping Address:

@_COMPANY_@
11480 Sunset Hills Road
Suite 200 East
Reston, VA 20190


Return Info:

   RMA Number: [scratch rma_number]
  Date Issued: [tag time]%Y%m%d %H:%M:%S[/tag]
		
 Order Number: [value order_number]
Item Quantity: [scratch total_qty]
Credit Amount: [currency][scratch return_credit][/currency]

					
[/email]

[/set]

[seti return_number][counter etc/return.number][/seti]

[comment] ADD ENTRY TO RETURN DATABASE [/comment]

[seti add_return]
[tag flag write]order_returns[/tag]
[try]
[import table=order_returns type=LINE continue=NOTES]
code: [scratch return_number]
order_number: [value order_number]
session: [data session id]
username: [data session username]
rma_number: [scratch rma_number]
nitems: [scratch total_qty]
total: [scratch return_credit]
return_date: [tag time]%Y%m%d %H:%M:%S[/tag]
update_date: 
[/import]
[/try]
[catch] There was an error adding the new address entry. [/catch]
[/seti]
					
[comment] UPDATE ORDER STATUS IN TRANSACTIONS [/comment]

[seti update_status]
[tag flag write]transactions[/tag]
[data
	table=transactions
	column=status
	key="[value order_number]"
	value="returned"
	]
[/seti]
	
[/else]
[/if]
					
[/else]
[/if]					
					
<!-- END CONTENT -->

@_LEFTONLY_BOTTOM_@
