	[calc]
		return unless $CGI->{mv_more_ip};
		$CGI->{mv_data_table} = $Values->{mv_data_table};
		return;
	[/calc]
[seti page_title]
	[either]
		[cgi page_title]
	[or]
		[L]Spreadsheet Edit:[/L] [cgi mv_data_table]
	[/either]
[/seti]
[seti page_banner]
	[either]
		[cgi page_banner]
	[or]
		Spreadsheet Edit: [page href=__UI_BASE__/db_metaconfig_spread
								form="
									ui_table=[cgi mv_data_table]
									ui_view=[cgi ui_meta_view]
								"][cgi mv_data_table]
	[/either]
[/seti]
[set ui_class]Admin[/set]
[seti help_name][either][cgi help_name][or]gensql.main[/either][/seti]
[seti icon_name][either][cgi icon_name][or]icon_config.gif[/either][/seti]

@_UI_STD_HEAD_@

[perl tables="[cgi mv_data_table] __UI_META_TABLE__"]
	my $table = $CGI->{mv_data_table};
	my $db = $Db{$table};
	my $mrec = $Tag->meta_record($table, $CGI->{ui_meta_view}) || {};
	$Values->{mv_data_table} = $table;
	$Values->{ui_data_key_name} = $db->config('KEY');
	my @fields = grep
				$_ ne $Values->{ui_data_key_name},
				split /[\0\s,]+/,
					$CGI->{ui_data_fields} ||
					$CGI->{mv_data_fields} ||
					$Values->{"spread:$table:ui_data_fields"} ||
					$mrec->{spread_fields}     ||
					$mrec->{attribute}     ||
					join(" ", $db->columns());
	$Values->{ui_data_fields} = join " ", @fields;

	$Values->{"ui_spread_meta:$table"} = $CGI->{"ui_spread_meta:$table"}
		if defined $CGI->{"ui_spread_meta:$table"};

	$Values->{ui_meta_display} = $Values->{"ui_spread_meta:$table"};

	$Values->{ui_spreadsheet_rows} =
		$Values->{"ui_spreadsheet_rows:$table"}
			||= $CGI->{"ui_spreadsheet_rows:$table"} || $mrec->{spread_height} || 10; 

	$Values->{ui_textarea_rows} =
		$Values->{"ui_textarea_rows:$table"} ||= $mrec->{spread_textarea_rows} || 4;

	$Values->{ui_spread_size} =
		$Values->{"ui_spread_size:$table"}
			||= $CGI->{"ui_spread_size:$table"} || $mrec->{spread_width} || 12; 

	return;
[/perl]
[if scratch ui_failure]
<BLOCKQUOTE>
<FONT COLOR=__CONTRAST__>[msg arg.0="[scratchd ui_failure]"]Error: %s[/msg]</FONT>
</BLOCKQUOTE>
[/if]
<FORM METHOD=POST ACTION="[base-url]/ui">
<INPUT TYPE=hidden NAME="mv_todo" VALUE="set">
<INPUT TYPE=hidden NAME="mv_nextpage" VALUE="@@MV_PAGE@@">
<INPUT TYPE=hidden NAME="mv_data_table" VALUE="[value mv_data_table]">
<INPUT TYPE=hidden NAME="mv_data_key" VALUE="[value ui_data_key_name]">
<INPUT TYPE=hidden NAME="mv_data_decode" VALUE="yes">
<INPUT TYPE=hidden NAME="mv_update_empty" VALUE="1">
<INPUT TYPE=hidden NAME="mv_update_empty_key" VALUE="0">
<INPUT TYPE=hidden NAME="ui_text_qualification" value="[cgi ui_text_qualification]">
<INPUT TYPE=hidden NAME="ui_return_to" value="[cgi ui_return_to]">
<INPUT TYPE=hidden NAME="mv_data_fields"
	VALUE="[db-columns columns='[value ui_data_fields]']">

<INPUT TYPE=hidden NAME="mv_data_function" VALUE="update">

[calc]
	@areas = grep /\S/, split /[\s,\0]+/, $Values->{ui_data_fields};
	$Scratch->{ui_num_col} = scalar(@areas) + 2;
	$Config->{NoSearch} = '';
	if ($CGI->{ui_text_qualification} and $CGI->{ui_text_qualification} =~ /=/ ) {
		my ($f, $s) = split /\s*=\s*/, $CGI->{ui_text_qualification} , 2;
		$CGI->{ui_text_qualification} = "co=1\nop=eq\nse=$s\nsf=$f";
	}
	elsif ($CGI->{ui_text_qualification}) {
		$CGI->{ui_text_qualification} = "se=$CGI->{ui_text_qualification}";
	}
	else {
		$CGI->{ui_text_qualification} = "ra=yes";
	}
	$CGI->{ui_description_field} =
		q{[data table=__UI_META_TABLE__
				col=field
				key="[cgi mv_data_table]"
			]};

	return;
[/calc]

[if !value ui_spreadsheet_rows]
[value name=ui_spreadsheet_rows set=10 hide=1]
[/if]
[search-region more=1 arg="
				[cgi ui_text_qualification]
				ml=[value ui_spreadsheet_rows]
				rf=[value ui_data_key_name]
				tf=[value ui_data_key_name]
				st=db
				sp=@@MV_PAGE@@
				fi=[value mv_data_table]
			"]

<table __UI_T_PROPERTIES__>

<tr>
<td colspan="[scratch ui_num_col]" class=rborder><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<TR class=rnorm CELLPADDING=2>
	<TH ALIGN=CENTER>&nbsp;</TH>
	<TH ALIGN=CENTER>[value ui_data_key_name]</TH>
	[row-edit
		columns="[value ui_data_fields]"
		height=`$Values->{"ui_textarea_rows:$Values->{mv_data_table}"}`
		textarea="[value name='ui_textarea_fields:[value mv_data_table]']"
		]
</TR>

<tr>
<td colspan="[scratch ui_num_col]" class=rspacer><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

	[search-list]
	[if-mm keys [item-code]]
<TR class=rnorm>
	<td><input type=checkbox name="batch_id" value="[item-code]"><input type=hidden name="[value ui_data_key_name]" value="[item-code]"></td>
	<TD>
	[page href="__UI_BASE__/flex_editor"
	form=|
		page_title=Edit [value mv_data_table]: [item-code]
		mv_data_table=[value mv_data_table]
		item_id=[item-code]
	|]<small><small><u>edit</u></small></small>&nbsp;<b>[item-code]</b></A>
	</TD>
	[row-edit
		key="[item-code]"
		size="[value ui_spread_size]"
		columns="[value ui_data_fields]"
		height=`
					my $tab = $Values->{mv_data_table};
					return $Values->{"ui_textarea_rows:$tab"};
				`
		textarea=`
					my $tab = $Values->{mv_data_table};
					return $Values->{"ui_textarea_fields:$tab"};
			`
		]
</TR>
	[/if-mm]
	[set row_number][item-increment][/set]
	[/search-list]

<TR class=rnorm>
	<td COLSPAN=2>
	<input type=text size=12 name="[value ui_data_key_name]">
	</TD>
	[row-edit blank=1 size="[value ui_spread_size]" columns="[value ui_data_fields]"]
</TR>

[more-list]
<tr>
<td colspan="[scratch ui_num_col]" class=rspacer><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
<tr>
<td class=rnorm>&nbsp;</td>
<td colspan="[calc]$Scratch->{ui_num_col} - 1[/calc]" class=rnorm>
	<FONT SIZE="+1">[msg arg.0="[more]"]More pages: %s[/msg] </FONT>
</td>
</tr>
[/more-list]

<tr>
<td colspan="[scratch ui_num_col]" class=rspacer><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td colspan="[scratch ui_num_col]" class=rborder><img src="bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td class=rnorm>&nbsp;</td>
<td colspan="[calc]$Scratch->{ui_num_col} - 1[/calc]" class=rnorm>


	<B></B>&nbsp;&nbsp;&nbsp;[button text="[L]Ok[/L]" bold=1]
		mv_todo=set
		[return-to click]
	[/button]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	[button text="[L]Change display[/L]"]
	mv_todo=return
	mv_data_table=[cgi mv_data_table]
	mv_nextpage=__UI_BASE__/spread_control
	[/button]
	[button text="[L]Delete checked rows[/L]"
		confirm="[L]Are you sure you want to delete the checked rows?[/L]"]
[flag type=write table="[cgi mv_data_table]"]
mv_nextpage=__UI_BASE__/flex_select
mv_auto_export=
mv_todo=return
[if-mm tables =d]
	[perl tables="[cgi mv_data_table]"]
		my $tab = $CGI->{mv_data_table};
		my $db  = $Db{$tab};
		unless ($db) {
			$Scratch->{ui_message} = "No table '$tab'";
			return;
		}
		my @items = split /\0/, $CGI->{batch_id};
		foreach my $item (@items) {
			if ($db->delete_record($item)) {
				$out .= "Deleted $item from table $tab<BR>";
			}
			else {
				$out .= "Item $item not in $tab table (or delete failed)<BR>";
			}
		}
		$Scratch->{ui_message} = $out;
		return;
	[/perl]
[else]
	[set ui_message][L]Not authorized to delete items.[/L][/set]
[/else]
[/if-mm]
	[return-to click]
[/button]&nbsp;&nbsp;&nbsp;
	<INPUT TYPE=submit NAME=mv_click VALUE="[L]Cancel[/L]">
	[if-mm super]
	<BR><b><INPUT TYPE=checkbox NAME=mv_auto_export [if !scratch ui_too_large]CHECKED [/if]VALUE="[value mv_data_table]">
		[L]Auto-export[/L]</b>
	[/if-mm]

</td>
</tr>

</TABLE>
</center>
[/search-region]
</FORM>



<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
