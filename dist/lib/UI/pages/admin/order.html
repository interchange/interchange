[calc]
	if ( $CGI->{showarchive} ) {
		delete $Values->{showpending};
		$Values->{showarchive} = 1;
		$Scratch->{archive_sense} = 'eq';
		$Scratch->{archive_img} = '@_UI_IMG_@admin/left.gif';
		$Scratch->{archive_nm} = 'unarchive';
		$Scratch->{archive_label} = 'archived';
	}
	elsif($CGI->{showpending}) {
		delete $Values->{showarchive};
		$Values->{showpending} = 1;
		$Scratch->{archive_sense} = 'ne';
		$Scratch->{archive_img} = '@_UI_IMG_@admin/right.gif';
		$Scratch->{archive_nm} = 'archive';
		$Scratch->{archive_label} = 'pending';
	}
	elsif(! $Values->{showarchive} and ! $Values->{showpending}) {
		delete $Values->{showarchive};
		$Values->{showpending} = 1;
		$Scratch->{archive_sense} = 'ne';
		$Scratch->{archive_img} = '@_UI_IMG_@admin/right.gif';
		$Scratch->{archive_nm} = 'archive';
		$Scratch->{archive_label} = 'pending';
	}
	return;
[/calc]

[value name=mv_data_table set=transactions hide=1]
[if-mm !tables]
[set ui_error]
	Not authorized for order administration. Contact administrator?
[/set]
[bounce page="__UI_BASE__/error"]
[/if-mm]

[set ui_class]Orders[/set]
[tmp page_perm]order=l[/tmp]

[tag flag write]transactions[/tag]
[perl tables=transactions]
	delete $Scratch->{ui_location};
	my $db = $Db{transactions};
	if(! $db) {
		$Scratch->{ui_error} = "<FONT CLASS=error>Error: no transactions database.</FONT><BR>";
		$Scratch->{ui_location} = "__UI_BASE__/error";
		return;
	}

	my ($value, $action_col);
	if($CGI->{archiveorder}) {
		$value = 1;
		$action_col = 'archived';
	}
	elsif($CGI->{unarchiveorder}) {
		$value = 0;
		$action_col = 'archived';
	}
	elsif($CGI->{deleteorder}) {
		$value = 1;
		$action_col = 'deleted';
	}
	elsif($CGI->{vieworder} and ! $CGI->{viewnext}) {
		$CGI->{order} =~ s/^\0+//;
		$CGI->{order} =~ s/\0+$//;
		$Scratch->{ui_location} = $Tag->area('__UI_BASE__/order_view', $CGI->{order});
	}
	elsif($CGI->{xload}) {
		$Scratch->{ui_location} = $Tag->area('__UI_BASE__/dbdownload');
	}
	else {
		$CGI->{order} =~ s/^\0+//;
		$CGI->{order} =~ s/\0.*//s;
		$Scratch->{start_at} = "sm=$CGI->{order}";
	}

	if($action_col) {
		for(grep $_, @{$CGI_array->{order}}) {
			$db->set_field($_, $action_col, $value);
		}
	}
	if(@errors) {
		my $plural = @errors > 1 ? 's' : '';
		return "<FONT CLASS=error>Error$plural:<UL><LI>" .
				join ("<LI>", @errors)                    .
				"</UL></FONT><BR>";
	}
	if($CGI->{viewnext}) {
		my $ordnum = $CGI->{order};
		$ordnum =~ s/[\0,\s].*//;
		return if ! $ordnum;
		$ordnum++;
		CHECKNEXT: {
			if (! $db->record_exists($ordnum) ) {
				undef $ordnum;
				last CHECKNEXT;
			}
			if ($db->field($ordnum, 'deleted') ) {
				$ordnum++;
				next CHECKNEXT;
			}
			if ($Values->{showarchive} and ! $db->field($ordnum, 'archived') ) {
				undef $ordnum;
				last CHECKNEXT;
			}
			else {
				last CHECKNEXT;
			}
		}
		if ($ordnum) {
			$Scratch->{ui_location} = $Tag->area(
									{
										href => '__UI_BASE__/order_view',
										form => "order=$ordnum",
									}
									);
		}
		else {
			$Scratch->{message} = "[L]No next order.[/L]";
		}
	}
	return;
[/perl]


[if scratch ui_location]
[bounce href=`delete $Scratch->{ui_location}`]
[/if]

[set icon_name]admin/icon_orders.gif[/set]
[seti page_title]
	[if value showarchive]
	[L]Orders[/L]: [L]Archived Orders[/L]
	[set help_name]order.main.archived[/set]
	[else]
	[L]Orders[/L]: [L]Pending Orders[/L]
	[set help_name]order.main.pending[/set]
	[/else]
	[/if]
[/seti]
[update values]

@_UI_STD_HEAD_@

[if scratch message]
<BLOCKQUOTE>
[scratch message]
</BLOCKQUOTE>
[set message][/set]
[/if]
</font>

<!-- ----- BEGIN REAL STUFF ----- -->

[if scratch ui_message]
<BLOCKQUOTE>
	[scratch ui_message]
	[set ui_message][/set]
</BLOCKQUOTE>
<p>
&nbsp;
[/if]

<table border=0><tr>
<td>
<small>
    <FORM ACTION="[area @@MV_PAGE@@]">
    <INPUT NAME=order VALUE="[cgi order]">
    <INPUT TYPE=submit VALUE="[L]Start at order number[/L]">
    </FORM>
</small>
</td>
<td valign=top><B> [L]or[/L] </B></td>
<td>
<small>
    <FORM ACTION="[area @@MV_PAGE@@]">
    <INPUT NAME=ui_text_qualification VALUE="">
    <INPUT TYPE=submit VALUE="[L]Limit with search[/L]">
    </FORM>
</small>
</td>
</tr>
</table>
[if cgi ui_text_qualification]
<H4>[L]Entries containing[/L] "[cgi ui_text_qualification]"</H3>
[/if]
[search-region more=1 arg="
		fi=transactions
		ml=__UI_SZ_LIST_ORDER__
		md=1
		st=db
		[if cgi ui_text_qualification]
			se=[cgi ui_text_qualification]
		[else]
			co=yes
			sf=archived
			se=1
			op=[scratch archive_sense]
			sf=deleted
			se=1
			op=ne
		[/else]
		[/if]
		[scratch start_at][set start_at][/set]
		[if cgi ui_sort_field]
			tf=[cgi ui_sort_field]
			to=[cgi ui_sort_option]
		[else]
			tf=0
		[/else]
		[/if]
		rf=code,order_date,total_cost,nitems,status,city,state,country,fname,lname,username
"]
[calc] 
	my $so   = $CGI->{ui_sort_option};
	my $fld  = $CGI->{ui_sort_field};
	my $qual = $CGI->{ui_text_qualification} ? "se=$CGI->{ui_text_qualification}" : '';
	$fld =~ s/[\s,\0].*//;
	sub sortrev {
		my ($f, $n) = @_;
		my $out = "$qual\nui_sort_option=";
		$out .= 'n' if $n;
		return $out unless ($fld eq $f) || ($f eq 'code');
		return $out if $so =~ /r/;
		return $out . 'r';
	}
	return;
[/calc]
<FORM ACTION="[process]" METHOD=POST NAME=batch>
<INPUT TYPE=hidden NAME=mv_nextpage VALUE="@@MV_PAGE@@">
<INPUT TYPE=hidden NAME=mv_todo VALUE=back>
<TABLE border=0 CELLSPACING=0 width="90%">
<tr bgcolor=000000 height=1><td colspan=8></td></tr>
<TR BGCOLOR="__UI_C_TITLEBARBG__">
<th>&nbsp;</th>
<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">
[page href=@@MV_PAGE@@ form=`
	return "ui_sort_field=code\n" . sortrev('code');
	`][L]Order[/L]</A>
</TH>
<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">
[page href=@@MV_PAGE@@ form=`
	return "ui_sort_field=lname,fname\n" . sortrev('lname');
	`][L]User[/L]</A>
</TH>
<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">
[page href=@@MV_PAGE@@ form=`
	return "ui_sort_field=country,state,city\n" . sortrev('country');
	`][L]Location[/L]</A>
</TH>
<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">
[page href=@@MV_PAGE@@ form=`
	return "ui_sort_field=order_date\n" . sortrev('order_date');
	`][L]Date[/L]/[L]Time[/L]</A>
</TH>
<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">
[page href=@@MV_PAGE@@ form=`
	return "ui_sort_field=nitems\n" . sortrev('nitems', 1);
`][L]Items[/L]</A>
</TH>
<TH ALIGN=CENTER><FONT SIZE=-1 COLOR="__UI_C_TITLEBARTXT__">
[page href=@@MV_PAGE@@ form=`
	return "ui_sort_field=total_cost\n" . sortrev('total_cost', 1);
`][L]Total[/L]</A>
</TH>
<TH ALIGN=RIGHT><FONT SIZE=-1 COLOR="__UI_C_TITLEBARTXT__">
[page href=@@MV_PAGE@@ form=`
	return "ui_sort_field=status\n" . sortrev('status');
`][L]Status[/L]</A>
</TH>
</tr>
<tr bgcolor=000000 height=1><td colspan=8></td></tr>
<tr bgcolor=FFFFFF height=2><td colspan=8></td></tr>
[search-list]
<TR [item-alternate 2]BGCOLOR="__UI_T_ROW_EVEN__"[else]BGCOLOR="__UI_T_ROW_ODD__"[/else][/item-alternate]>
<TD>
<INPUT TYPE=checkbox NAME=order VALUE="[item-code]"
		[item-calc]
			return if $Scratch->{archive_nm} eq 'unarchive';
			return 'CHECKED' if q{[item-data transactions status]} eq '__UI_SHIPPED_STATUS__';
			return;
		[/item-calc]
		>
[page href="@@MV_PAGE@@"
	form="
		[scratch archive_nm]order=1
		order=[item-code]
	"]<IMG SRC="[scratch archive_img]" HEIGHT=10 WIDTH=11 ALT="[scratch archive_nm] [item-code]" BORDER=0></A>
<A HREF="[area
	href='@@MV_PAGE@@'
	form='
		deleteorder=1
		order=[item-code]
	']"
	onClick="return confirm('Are you sure you want to delete order [item-code]?')"><IMG src="@_UI_IMG_@admin/delsm.gif" ALT="DELETE [item-code]" BORDER=0></A>
</TD>
<TD>[page href=__UI_BASE__/order_view form="order=[item-code]"][item-code]</A></TD>
<TD>
	[page href=__UI_BASE__/customer_view form="customer=[item-param username]"][item-param lname], [item-param fname][if-item-param company] -- [item-param company][/if-item-param]</A>
</TD>
<TD>[item-filter 30][item-param city], [item-param state] [item-param country][/item-filter]</TD>
<TD ALIGN=LEFT>[convert-date][item-param order_date][/convert-date]</TD>
<TD ALIGN=CENTER>[item-param nitems]</TD>
<TD ALIGN=Right>[currency][item-param total_cost][/currency]</TD>
<TD ALIGN=Right>[page href="__UI_BASE__/order_status" form="order=[item-code]"][item-param status]</A></TD>
</tr>
[/search-list]
[no-match]
<tr>
<td colspan=6>
<br>
<B>[L]No orders[/L]</B>
<br><br>
</td>
</tr>
[/no-match]
<tr bgcolor=000000 height=1><td colspan=8></td></tr>
<tr bgcolor=FFFFFF height=8><td colspan=8></td></tr>
[more-list]
<tr>
<td colspan=6 align=center>
Orders [matches] of [value mv_search_match_count] [scratch archive_label] displayed. More orders: [decade-next][/decade-next] [more] [decade-prev][/decade-prev]
</td>
</tr>
[/more-list]
</table>
[if-mm advanced order=d]
[button form=batch text="[L]Delete checked orders[/L]"
 confirm='[L]Are you sure you want to delete the checked orders?[/L]']deleteorder=1
[/button]
[/if-mm]
&nbsp;&nbsp;&nbsp;[button form=batch src="@_UI_IMG_@admin/[scratch archive_img]"
			text=`
			my $tmp = "$Scratch->{archive_nm} checked orders";
			return "\u$tmp";
			`]
[scratch archive_nm]order=1[/button]
</FORM>
[/search-region]
<!-- ----- END REAL STUFF ----- -->


@_UI_STD_FOOTER_@
<!-- page: @@MV_PAGE@@ -->
