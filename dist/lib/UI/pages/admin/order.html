[calc]
	if ( $CGI->{showarchive} ) {
		delete $Values->{showpending};
		$Values->{showarchive} = 1;
		$Scratch->{archive_sense} = 'eq';
		$Scratch->{archive_img} = 'left.gif';
		$Scratch->{archive_nm} = 'unarchive';
		$Scratch->{archive_label} = 'archived';
	}
	elsif($CGI->{showpending}) {
		delete $Values->{showarchive};
		$Values->{showpending} = 1;
		$Scratch->{archive_sense} = 'ne';
		$Scratch->{archive_img} = 'right.gif';
		$Scratch->{archive_nm} = 'archive';
		$Scratch->{archive_label} = 'pending';
	}
	elsif(! $Values->{showarchive} and ! $Values->{showpending}) {
		delete $Values->{showarchive};
		$Values->{showpending} = 1;
		$Scratch->{archive_sense} = 'ne';
		$Scratch->{archive_img} = 'right.gif';
		$Scratch->{archive_nm} = 'archive';
		$Scratch->{archive_label} = 'pending';
	}
	return;
[/calc]
[set icon_name]icon_orders.gif[/set]
[seti page_title]
	[if value showarchive]
	[L]Orders[/L]: [L]Archived Orders[/L]
	[set help_name]order.main.archived[/set]
	[else]
	[L]Orders[/L]: [L]Pending Orders[/L]
	[set help_name]order.main.pending[/set]
	[/else]
	[/if]
[/seti]
[set ui_class]Orders[/set]
[tmp page_perm]order=l[/tmp]

@_UI_STD_HEAD_@

[comment]
<!-- sequence_edit: [cgi ui_sequence_edit] -->
<!-- item_id_left: [cgi item_id_left] -->
[/comment]

[value name=mv_data_table set=transactions hide=1]
[if-mm !tables]
[set ui_error]
	[L]Not authorized for order administration. Contact administrator?[/L]
[/set]
[bounce page="__UI_BASE__/error"]
[/if-mm]

[tmp can_delete][if-mm advanced order=d]1[/if-mm][/tmp]

[include include/order_delete_archive]

[perl tables="[cgi mv_data_table] [scratch extra_tables] __UI_META_TABLE__"]
	delete $Scratch->{ui_location};
	my $dest = $CGI->{ui_sequence_destination} || '__UI_BASE__/order_status';
	if($CGI->{ui_sequence_edit}) {
		my $doit;
		$CGI->{item_id_left} =~ s/-_NULL_-/\0/g;
		$CGI->{item_id_left} =~ s/\0+/,/g;
		$CGI->{item_id_left} =~ s/,+/,/g;
		if($CGI->{item_id_left} =~ s/^(.*?),//) {
			$CGI->{item_id} = $1;
			$doit = 1;
		}
		elsif ($CGI->{item_id_left}) {
			$CGI->{item_id} = delete $CGI->{item_id_left};
			delete $CGI->{ui_sequence_edit};
			$doit = 1;
		}
		else {
			delete $CGI->{item_id};
			delete $CGI->{ui_sequence_edit};
		}
		return unless $doit;
		$Scratch->{ui_location}
				= $Tag->area( {
						href => $dest,
						form => qq{
							item_id=$CGI->{item_id}
							item_id_left=$CGI->{item_id_left}
							ui_sequence_edit=$CGI->{ui_sequence_edit}
						},
					});
		return;
	}

[/perl]

[calc]
	if ($CGI->{mv_like_spec}) {
		my @f = split /\0/, $CGI->{mv_like_field};
		my @s = split /\0/, $CGI->{mv_like_spec};
		my @q = 'ra=yes';
		my $found;
		for(my $i = 0; $i < @f; $i++) {
			next unless length $s[$i];
			$found++;
			push @q, "lf=$f[$i]";
			push @q, "ls=$s[$i]";
		}
		if($found) { $CGI->{ui_text_qualification} = join "\n", @q; }
		else	   { $CGI->{ui_text_qualification} = "" }
	}
	return if $CGI->{ui_text_qualification};
	return unless $Config->{Database}{transactions}{LARGE};
	$Scratch->{ui_location} = $Tag->area( {
									
									href => '__UI_BASE__/flex_select',
									form => q(
										mv_data_table=transactions
										page_title=Order select
										page_banner=Order select
										ui_searchpage=__UI_BASE__/order
									),
								},
								);
	return;
[/calc]

[if scratch ui_location]
[comment]Comes from above include[/comment]
[bounce href=`delete $Scratch->{ui_location}`]
[/if]

[update values]

[if scratch message]
<BLOCKQUOTE>
[scratchd message]
</BLOCKQUOTE>
[/if]
</font>

<!-- ----- BEGIN REAL STUFF ----- -->

<table border=0><tr>
<td>
<small>
    <FORM ACTION="[area @@MV_PAGE@@]">
    <INPUT NAME=order VALUE="[cgi order]">
    <INPUT TYPE=submit VALUE="[L]Start at order number[/L]">
    </FORM>
</small>
</td>
<td valign=top><B> [L]or[/L] </B></td>
<td>
<small>
    <FORM ACTION="[area @@MV_PAGE@@]">
    <INPUT NAME=ui_text_qualification VALUE="">
    <INPUT TYPE=submit VALUE="[L]Limit with search[/L]">
    </FORM>
</small>
</td>
</tr>
</table>

[if cgi ui_text_qualification]
[if !cgi mv_like_spec]
<H4>[msg arg.0="[cgi ui_text_qualification]"]Entries containing "%s"[/msg]</H4>
[/if]
[/if]
[search-region more=1 arg="
		fi=transactions
		ml=__UI_SZ_LIST_ORDER__
		md=1
		st=db
		[if cgi mv_like_spec]
			[cgi ui_text_qualification]
		[elsif cgi ui_text_qualification]
			se=[cgi ui_text_qualification]
		[/elsif]
		[else]
			co=yes
			sf=archived
			se=1
			op=[scratch archive_sense]
			sf=deleted
			se=1
			op=ne
		[/else]
		[/if]
		[scratch start_at][set start_at][/set]
		[if cgi ui_sort_field]
			tf=[cgi ui_sort_field]
			to=[cgi ui_sort_option]
		[else]
			tf=0
		[/else]
		[/if]
		rf=code,order_date,total_cost,nitems,status,city,state,country,fname,lname,username,company
"]
[calc] 
	my $so   = $CGI->{ui_sort_option};
	my $fld  = $CGI->{ui_sort_field};
	my $qual = $CGI->{ui_text_qualification} ? "se=$CGI->{ui_text_qualification}" : '';
	$fld =~ s/[\s,\0].*//;
	sub sortrev {
		my ($f, $n) = @_;
		my $out = "$qual\nui_sort_option=";
		$out .= 'n' if $n;
		return $out unless ($fld eq $f) || ($f eq 'code');
		return $out if $so =~ /r/;
		return $out . 'r';
	}
	return;
[/calc]
<FORM ACTION="[process]" METHOD=POST NAME=batch>
<INPUT TYPE=hidden NAME=mv_session_id VALUE="[data session id]">
<INPUT TYPE=hidden NAME=mv_nextpage VALUE="@@MV_PAGE@@">
<INPUT TYPE=hidden NAME=mv_todo VALUE=back>
<TABLE border=0 CELLSPACING=0 width="90%">
<tr class=rborder height=1><td colspan=8></td></tr>
<TR class=rmarq>
<th>&nbsp;</th>
<TH ALIGN=LEFT>
[page href=@@MV_PAGE@@ extra=rmarq form=`
	return "ui_sort_field=code\n" . sortrev('code');
	`][L]Order[/L]</A>
</TH>
<TH ALIGN=LEFT>
[page href=@@MV_PAGE@@ extra=rmarq form=`
	return "ui_sort_field=lname,fname\n" . sortrev('lname');
	`][L]User[/L]</A>
</TH>
<TH ALIGN=LEFT>
[page href=@@MV_PAGE@@ extra=rmarq form=`
	return "ui_sort_field=country,state,city\n" . sortrev('country');
	`][L]Location[/L]</A>
</TH>
<TH ALIGN=LEFT>
[page href=@@MV_PAGE@@ extra=rmarq form=`
	return "ui_sort_field=order_date\n" . sortrev('order_date');
	`][L]Date[/L]/[L]Time[/L]</A>
</TH>
<TH ALIGN=LEFT>
[page href=@@MV_PAGE@@ extra=rmarq form=`
	return "ui_sort_field=nitems\n" . sortrev('nitems', 1);
`][L]Items[/L]</A>
</TH>
<TH ALIGN=CENTER>
[page href=@@MV_PAGE@@ extra=rmarq form=`
	return "ui_sort_field=total_cost\n" . sortrev('total_cost', 1);
`][L]Total[/L]</A>
</TH>
<TH ALIGN=RIGHT>
[page href=@@MV_PAGE@@ extra=rmarq form=`
	return "ui_sort_field=status\n" . sortrev('status');
`][L]Status[/L]</A>
</TH>
</tr>
<tr class=rborder height=1><td colspan=8></td></tr>
[search-list]
<TR [item-alternate 2]class=rnorm[else]class=ralt[/else][/item-alternate]>
<TD>
<INPUT TYPE=checkbox NAME=order VALUE="[item-code]"
		[item-calc]
			return if $Scratch->{archive_nm} eq 'unarchive';
			return 'CHECKED' if q{[item-data transactions status]} eq '__UI_SHIPPED_STATUS__';
			return;
		[/item-calc]
		>
[page href="@@MV_PAGE@@"
	form="
		[scratch archive_nm]order=1
		order=[item-code]
	"]<IMG SRC="[scratch archive_img]" HEIGHT=10 WIDTH=11 ALT="[scratch archive_nm] [item-code]" BORDER=0></A>
[if scratch can_delete]
<A HREF="[area
	href='@@MV_PAGE@@'
	form='
		deleteorder=1
		order=[item-code]
	']"
	onClick="return confirm('Are you sure you want to delete order [item-code]?')"><IMG src="delsm.gif" ALT="DELETE [item-code]" BORDER=0></A>
[/if]
</TD>
<TD>[page href=__UI_BASE__/order_view form="order=[item-code]"][item-code]</A></TD>
<TD>
	[page href=__UI_BASE__/customer_view form="customer=[item-param username]"][item-param lname], [item-param fname][if-item-param company] -- [item-param company][/if-item-param]</A>
</TD>
<TD>[item-filter 30][item-param city], [item-param state] [item-param country][/item-filter]</TD>
<TD ALIGN=LEFT>[convert-date][item-param order_date][/convert-date]</TD>
<TD ALIGN=CENTER>[item-param nitems]</TD>
<TD ALIGN=Right>[currency][item-param total_cost][/currency]</TD>
<TD ALIGN=Right>[page href="__UI_BASE__/order_status" form="order=[item-code]"][loc][item-param status][/loc]</A></TD>
</tr>
[/search-list]
[no-match]
<tr>
<td colspan=8>
<br>
<B>[L]No orders[/L]</B>
<br><br>
</td>
</tr>
[/no-match]
<tr class=rborder height=1><td colspan=8></td></tr>
[more-list]
<tr class=ralt>
<td colspan=8 align=center>
<br>
<b>[msg arg.0="[matches]" arg.1="[value mv_search_match_count]"]Orders %s of %s [scratch archive_label] displayed.[/msg] [L]More orders[/L]:</b> [decade-next][/decade-next] [more] [decade-prev][/decade-prev]
<br>
&nbsp;
</td>
</tr>
[/more-list]
</table>

[if scratch can_delete]
[button form=batch text="[L]Delete checked orders[/L]"
 src="__UI_IMG__delete.gif"
 link-text-too=1
 confirm='[L]Are you sure you want to delete the checked orders?[/L]']deleteorder=1
[/button]
[/if]
&nbsp;&nbsp;&nbsp;[button form=batch src="[scratch archive_img]"
			 link-text-too=1
			text=`
			my $tmp = "$Scratch->{archive_nm} checked orders";
			return errmsg("\u$tmp");
			`]
[scratch archive_nm]order=1[/button]

&nbsp;&nbsp;&nbsp;[button form=batch src="__UI_IMG__icon_merch.gif"
			link-text-too=1
			text="Ship checked orders"
			]
ui_sequence_edit=[calc]
	$CGI->{item_id} = delete $CGI->{order};
	$CGI->{item_id_left} = $CGI->{item_id};
	$CGI->{item_id_left} =~ s/\0+/,/g;
	if($CGI->{item_id_left} =~ s/^(.*?),//) {
		$CGI->{item_id} = $1;
		return 1;
	}
	else {
		delete $CGI->{item_id_left};
		return '';
	}
[/calc]
mv_nextpage=__UI_BASE__/order_status
[/button]

&nbsp;
&nbsp;
&nbsp;
&nbsp;
<table>
	<tr>
		<td>

<A HREF="javascript:checkAll(document.batch, 'order', 0)"><img src="__UI_IMG__box_checked.gif" border=0>Check all</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<A HREF="javascript:checkAll(document.batch, 'order', 1)"><img src="__UI_IMG__box_empty.gif" border=0>Uncheck all</A>

		</td>

[if scratch old_browser]
	<td>
<input type=checkbox name=ship_auto value=1> <span title="Ship all lines of all orders, archive[if variable SETTLE_TRANSACTION], settle[/if]">Ship all automatically</span>
	</td>
[else]
	<td>
<script>
	function div_vis (show) {
		var el = document.getElementById('ship_auto_help');
		el.style.display = show ? 'block' : 'none';
	}
</script>
		<span onMouseOver="div_vis(1)" onMouseOut="div_vis(0)">
			<input type=checkbox name=ship_auto value=1> Ship all automatically
		&nbsp;
		&nbsp;
		</span>
		</td>
		<td height=50>
			<div
				id=ship_auto_help
				style="
					display: none;
					border: 2px solid black;
					padding: 5px;
				">
				Ship all lines of all orders,<br>
				archive[if variable SETTLE_TRANSACTION], settle[/if]
			</div>
		</td>

[/else]
[/if]

	</tr>
</table>
</FORM>
[/search-region]
<!-- ----- END REAL STUFF ----- -->


@_UI_STD_FOOTER_@
<!-- page: @@MV_PAGE@@ version: $Id: order.html,v 2.9 2002-10-17 04:46:23 mheins Exp $ -->
