[set page_title]Upload File[/set]
[set page_banner]Upload File[/set]
[set ui_class]Content[/set]
[set page_perm]files[/set]
[set icon_name]admin/icon_config.gif[/set]

[if-mm function="!files" name="[data session arg]"]
[seti ui_error]Not authorized to upload file [data session arg].[/seti]
[bounce page="__UI_BASE__/error"]
[/if-mm]

@_UI_STD_HEAD_@

<!-- BEGIN REAL STUFF -->

<FORM ACTION="[process-target]" METHOD=POST ENCTYPE="multipart/form-data">
<INPUT TYPE=hidden NAME=mv_todo VALUE="return">
<INPUT TYPE=hidden NAME=mv_nextpage VALUE="__UI_BASE__/do_upload">
[return-to][comment]This passes the right form vars for return processing[/comment]
<INPUT TYPE=hidden NAME=ui_preload VALUE="[cgi ui_preload]">

<table __UI_T_PROPERTIES__>

<tr>
<td bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr>
<td bgcolor=__UI_C_INTBLOCK__>
	[if type=explicit compare=`$Session->{arg} =~ m{[^/]$}`]
	Uploading file <b>[data session arg]</B>
	<INPUT type=hidden NAME=ui_upload_fn VALUE="[data session arg]">
	[elsif session arg]
	Uploading file to 
	<INPUT NAME=ui_upload_fn VALUE="[data session arg]" SIZE=40>
	[comment]
	<B>File to upload</B>
		<BLOCKQUOTE>
		<INPUT NAME=ui_upload_fn type=hidden VALUE="[data session arg]">
		<INPUT NAME=ui_upload_fn SIZE=40>
		</BLOCKQUOTE>
	[/comment]
	[/elsif]
	[else]
	<B>File to upload</B>
		<BLOCKQUOTE>
		<INPUT NAME=ui_upload_fn SIZE=40>
		</BLOCKQUOTE>
	[/else]
	[/if]

</td>
</tr>

<tr>
<td bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
[set existing][/set]
[if type=explicit compare=`$CGI->{ui_image_preview} =~ m{[^/]$}`]
[set existing]1[/set]
<tr>
<td bgcolor=__UI_C_INTBLOCK__>
Preview: <BR>
<IMG SRC="[cgi ui_image_preview]">
</td>
</tr>
[/if]
<tr>
<td bgcolor=__UI_C_INTBLOCK__>
<B>Local file</B><BR>
	<BLOCKQUOTE>
	<INPUT TYPE=file NAME="ui_upload_file" SIZE=40>
	</BLOCKQUOTE>
<P>
<B>Upload mode</B>
	<BLOCKQUOTE>
[if session arg =~ /\.(gif|jpe?g|png)$/i]
[or cgi ui_upload_binary]
	<INPUT NAME=ui_upload_ascii TYPE=radio VALUE=1>&nbsp;ASCII<BR>
	<INPUT NAME=ui_upload_ascii TYPE=radio VALUE=0 CHECKED>&nbsp;Binary
	<P>
	[if scratch existing]
	<INPUT NAME=ui_upload_newfn TYPE=radio VALUE=1>&nbsp;Use new file name<BR>
	<INPUT NAME=ui_upload_newfn TYPE=radio VALUE=0 CHECKED>&nbsp;Use existing file name
	[/if]
[else]
	<INPUT NAME=ui_upload_ascii TYPE=radio VALUE=1 CHECKED>&nbsp;ASCII<BR>
	<INPUT NAME=ui_upload_ascii TYPE=radio VALUE=0>&nbsp;Binary
[/else]
[/if]
	</BLOCKQUOTE>
<P>
<B>Backup mode</B>
	<BLOCKQUOTE>
	[if cgi ui_backup]
	<INPUT NAME=ui_backup TYPE=radio VALUE=1 CHECKED>&nbsp;Back up<BR>
	<INPUT NAME=ui_backup TYPE=radio VALUE=0>&nbsp;NO backup
	[else]
	<INPUT NAME=ui_backup TYPE=radio VALUE=1>&nbsp;Back up<BR>
	<INPUT NAME=ui_backup TYPE=radio VALUE=0 CHECKED>&nbsp;NO backup
	[/else]
	[/if]
	</BLOCKQUOTE>
<P>
[button text="Upload" src="@_UI_IMG_@admin/upload.gif"]
	[calc]
		if( $CGI->{ui_upload_newfn} or $CGI->{ui_upload_fn} =~ m:/$:) {
			my $image = $CGI->{ui_upload_file};
			$image =~ s:.*[\\/]::;
			$CGI->{ui_upload_fn} =~ s:/[^/]*$:/:;
			$CGI->{ui_upload_fn} .= $image;
			$Session->{ui_message} = sprintf ("[L]Uploaded file: %s[/L]", $image);
			if($CGI->{ui_preload}) {
				my $pre =
					$CGI->{ui_preload} =~ /:/
					?  $CGI->{ui_preload}
					: "$Values->{mv_data_table}:$CGI->{ui_preload}";
#Log("preloading $pre=$image");
				$CGI->{ui_return_to} .= "\0ui_preload:$pre=$image";
#Log(qq{actual preload: CGI->{"ui_preload:$pre"} = $CGI->{"ui_preload:$pre"}});
			}
		}

		$regex = q{@_UI_CONST_IMAGE_REGEX_@} || '\.(?:gif|jpe?g|png)$';
		if( $CGI->{ui_upload_fn} =~ m{$regex}i) {
			$CGI->{ui_upload_umask} = '022';
		}
		return;
	[/calc]
[/button]
[button text="Cancel" src="@_UI_IMG_@admin/dalete.gif"]
	[return-to click]
	mv_todo=back
[/button]

</FORM>
</td>
</tr>

<tr>
<td bgcolor=__UI_C_TOPBLOCKBAR__><img src="@_UI_IMG_@admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

</table>

<!-- END REAL STUFF -->

@_UI_STD_FOOTER_@

